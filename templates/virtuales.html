{% extends "base.html" %} {% block content %}
<div class="space-y-6">
  <!-- Header -->
  <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
    <div>
      <h1 class="text-2xl font-semibold text-gray-900">Virtuales</h1>
      <p class="mt-1 text-sm text-gray-600">
        Master unificado de virtuales – consulta de registros
      </p>
    </div>
  </div>

  <!-- Tarjetas informativas -->
  <dl class="grid grid-cols-2 gap-4 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6">
    <!-- Total -->
    <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow-sm sm:p-6">
      <dt class="truncate text-sm font-medium text-gray-500">Total</dt>
      <dd class="mt-1 text-2xl font-semibold tracking-tight text-gray-900">{{ "{:,}".format(total_virtuales) }}</dd>
    </div>
    <!-- Por estatus -->
    {% for estatus, count in estatus_counts.items() %}
    <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow-sm sm:p-6">
      <dt class="truncate text-sm font-medium text-gray-500" title="{{ estatus }}">{{ estatus }}</dt>
      <dd class="mt-1 text-2xl font-semibold tracking-tight text-[#003D89]">{{ "{:,}".format(count) }}</dd>
    </div>
    {% endfor %}
  </dl>

  <!-- Panel de filtros -->
  <div class="rounded-lg bg-white p-6 shadow-sm">
    <div class="flex flex-wrap items-end gap-4">
      <div class="flex-1 min-w-[200px]">
        <label for="busqueda-virtuales" class="block text-sm font-medium text-gray-900">Buscar</label>
        <div class="mt-2">
          <input
            type="text"
            id="busqueda-virtuales"
            placeholder="Número, pedimento, agente, proveedor/cliente, estatus, tipo, firma..."
            class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-[#003D89] sm:text-sm"
          />
        </div>
      </div>
      <div class="flex items-end gap-2">
        <button
          id="btn-limpiar-virtuales"
          type="button"
          class="rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-[#003D89] focus:ring-offset-2"
        >
          Limpiar
        </button>
      </div>
    </div>

    <div class="mt-4 flex flex-wrap items-center gap-4">
      <div class="flex items-center gap-2">
        <label for="registros-pagina-virtuales" class="text-sm text-gray-600">Mostrar</label>
        <select
          id="registros-pagina-virtuales"
          class="rounded-md border border-gray-300 bg-white px-2 py-1 text-sm focus:border-[#003D89] focus:outline-none focus:ring-1 focus:ring-[#003D89]"
        >
          <option value="25">25</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
        <span class="text-sm text-gray-600">por página</span>
      </div>
    </div>
  </div>

  <!-- Tabla -->
  <div class="rounded-lg bg-white shadow-sm">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200" id="tabla-virtuales">
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" class="cursor-pointer px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 hover:bg-gray-100" data-sort="numero">Número</th>
            <th scope="col" class="cursor-pointer px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 hover:bg-gray-100" data-sort="proveedor_cliente">Proveedor/Cliente</th>
            <th scope="col" class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Impo/Expo</th>
            <th scope="col" class="cursor-pointer px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 hover:bg-gray-100" data-sort="pedimento">Pedimento</th>
            <th scope="col" class="cursor-pointer px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 hover:bg-gray-100" data-sort="agente">Agente</th>
            <th scope="col" class="cursor-pointer px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 hover:bg-gray-100" data-sort="aduana">Aduana</th>
            <th scope="col" class="cursor-pointer px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 hover:bg-gray-100" data-sort="patente">Patente</th>
            <th scope="col" class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Cliente Space</th>
            <th scope="col" class="cursor-pointer px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 hover:bg-gray-100" data-sort="mes">Mes</th>
            <th scope="col" class="cursor-pointer px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 hover:bg-gray-100" data-sort="estatus">Estatus</th>
            <th scope="col" class="cursor-pointer px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 hover:bg-gray-100" data-sort="tipo">Tipo</th>
            <th scope="col" class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Firma</th>
            <th scope="col" class="cursor-pointer px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 hover:bg-gray-100" data-sort="fecha_pago">Fecha pago</th>
            <th scope="col" class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Factura</th>
            <th scope="col" class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Plazo</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200 bg-white" id="tabla-virtuales-body">
          <tr id="fila-sin-datos-virtuales">
            <td colspan="15" class="px-6 py-12 text-center text-sm text-gray-500">
              <div class="flex flex-col items-center">
                <svg class="h-12 w-12 text-gray-400 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <p class="font-medium text-gray-500">No hay registros</p>
                <p class="mt-1 text-gray-400">Los datos se mostrarán aquí cuando estén disponibles</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Paginación -->
    <div class="flex flex-wrap items-center justify-between gap-4 border-t border-gray-200 px-4 py-4 sm:px-6">
      <div class="flex items-center gap-2">
        <button
          id="btn-primera-virtuales"
          type="button"
          class="rounded-md border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
          disabled
        >
          <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="m18.75 4.5-7.5 7.5 7.5 7.5m-6-15L5.25 12l7.5 7.5" />
          </svg>
        </button>
        <button
          id="btn-anterior-virtuales"
          type="button"
          class="rounded-md border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
          disabled
        >
          <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
          </svg>
        </button>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-sm text-gray-600">Página</span>
        <input
          type="number"
          id="pagina-actual-virtuales"
          value="1"
          min="1"
          class="w-16 rounded-md border border-gray-300 bg-white px-2 py-1 text-center text-sm focus:border-[#003D89] focus:outline-none focus:ring-1 focus:ring-[#003D89]"
        />
        <span class="text-sm text-gray-600">de <span id="total-paginas-virtuales">1</span></span>
      </div>
      <div class="flex items-center gap-2">
        <button
          id="btn-siguiente-virtuales"
          type="button"
          class="rounded-md border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
          disabled
        >
          <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" />
          </svg>
        </button>
        <button
          id="btn-ultima-virtuales"
          type="button"
          class="rounded-md border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
          disabled
        >
          <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="m5.25 4.5 7.5 7.5-7.5 7.5m6-15 7.5 7.5-7.5 7.5" />
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Datos ocultos -->
<div id="datos-virtuales" style="display: none;">
  {% for v in virtuales %}
  <div
    data-virtual-item
    data-numero="{{ v.numero or '' }}"
    data-pedimento="{{ v.pedimento or '' }}"
    data-agente="{{ v.agente or '' }}"
    data-aduana="{{ v.aduana or '' }}"
    data-patente="{{ v.patente or '' }}"
    data-cliente-space="{{ v.cliente_space or '' }}"
    data-impo-expo="{{ v.impo_expo or '' }}"
    data-proveedor-cliente="{{ v.proveedor_cliente or '' }}"
    data-mes="{{ v.mes or '' }}"
    data-estatus="{{ v.estatus or '' }}"
    data-tipo="{{ v.tipo or '' }}"
    data-firma="{{ v.firma or '' }}"
    data-fecha-pago="{% if v.fecha_pago %}{{ v.fecha_pago.isoformat() }}{% endif %}"
    data-factura="{{ v.factura or '' }}"
    data-plazo="{{ v.plazo or '' }}"
  ></div>
  {% endfor %}
</div>

<script>
(function() {
  let todos = [];
  let filtrados = [];
  let pagina = 1;
  let porPagina = 25;
  let sortCol = 'numero';
  let sortAsc = true;

  function esc(s) {
    const d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }

  function fmtFecha(iso) {
    if (!iso) return '—';
    try {
      const d = new Date(iso);
      if (isNaN(d.getTime())) return iso;
      return d.toLocaleDateString('es-MX', { day: '2-digit', month: '2-digit', year: 'numeric' });
    } catch (_) { return iso; }
  }

  function extraer() {
    const els = document.querySelectorAll('#datos-virtuales [data-virtual-item]');
    todos = [];
    els.forEach(el => {
      todos.push({
        numero: el.dataset.numero || '',
        pedimento: el.dataset.pedimento || '',
        agente: el.dataset.agente || '',
        aduana: el.dataset.aduana || '',
        patente: el.dataset.patente || '',
        clienteSpace: el.dataset.clienteSpace || '',
        impoExpo: el.dataset.impoExpo || '',
        proveedorCliente: el.dataset.proveedorCliente || '',
        mes: el.dataset.mes || '',
        estatus: el.dataset.estatus || '',
        tipo: el.dataset.tipo || '',
        firma: el.dataset.firma || '',
        fechaPago: el.dataset.fechaPago || '',
        factura: el.dataset.factura || '',
        plazo: el.dataset.plazo || ''
      });
    });
  }

  function cumpleFiltro(v, q) {
    if (!q) return true;
    const t = q.toLowerCase();
    const s = [
      v.numero, v.pedimento, v.agente, v.aduana, v.patente,
      v.clienteSpace, v.impoExpo, v.proveedorCliente, v.mes,
      v.estatus, v.tipo, v.firma, v.factura, v.plazo
    ].join(' ').toLowerCase();
    return s.includes(t);
  }

  function aplicarFiltros() {
    const q = (document.getElementById('busqueda-virtuales').value || '').trim();
    filtrados = todos.filter(v => cumpleFiltro(v, q));
    const cmp = (a, b) => {
      let va = a[sortCol] ?? '', vb = b[sortCol] ?? '';
      if (sortCol === 'numero' || sortCol === 'pedimento' || sortCol === 'aduana' || sortCol === 'patente') {
        const na = parseInt(va, 10), nb = parseInt(vb, 10);
        if (!isNaN(na) && !isNaN(nb)) return sortAsc ? na - nb : nb - na;
        va = String(va); vb = String(vb);
      } else if (sortCol === 'fechaPago') {
        const ta = va ? new Date(va).getTime() : 0, tb = vb ? new Date(vb).getTime() : 0;
        return sortAsc ? ta - tb : tb - ta;
      } else {
        va = String(va).toLowerCase();
        vb = String(vb).toLowerCase();
      }
      if (va < vb) return sortAsc ? -1 : 1;
      if (va > vb) return sortAsc ? 1 : -1;
      return 0;
    };
    filtrados.sort(cmp);
    pagina = 1;
    actualizarPaginacion();
  }

  function actualizarPaginacion() {
    const total = filtrados.length;
    const totalPag = Math.max(1, Math.ceil(total / porPagina));
    const from = (pagina - 1) * porPagina;
    const to = Math.min(from + porPagina, total);
    const paginasEl = document.getElementById('total-paginas-virtuales');
    const actualEl = document.getElementById('pagina-actual-virtuales');
    if (paginasEl) paginasEl.textContent = totalPag;
    if (actualEl) { actualEl.value = pagina; actualEl.max = totalPag; }
    const btns = ['btn-primera-virtuales', 'btn-anterior-virtuales', 'btn-siguiente-virtuales', 'btn-ultima-virtuales'];
    btns.forEach(id => {
      const b = document.getElementById(id);
      if (!b) return;
      if (id.includes('primera') || id.includes('anterior')) b.disabled = pagina <= 1;
      else b.disabled = pagina >= totalPag;
    });
    render(from, to);
  }

  function render(from, to) {
    const tbody = document.getElementById('tabla-virtuales-body');
    const sinDatos = document.getElementById('fila-sin-datos-virtuales');
    if (!tbody) return;
    const slice = filtrados.slice(from, to);
    sinDatos.classList.add('hidden');
    const exists = tbody.querySelectorAll('tr:not(#fila-sin-datos-virtuales)');
    exists.forEach(tr => tr.remove());
    slice.forEach(v => {
      const tr = document.createElement('tr');
      tr.className = 'hover:bg-gray-50';
      tr.innerHTML =
        '<td class="whitespace-nowrap px-4 py-3 text-sm font-medium text-gray-900">' + esc(v.numero) + '</td>' +
        '<td class="px-4 py-3 text-sm text-gray-600 max-w-[180px] truncate" title="' + esc(v.proveedorCliente) + '">' + esc(v.proveedorCliente) + '</td>' +
        '<td class="whitespace-nowrap px-4 py-3 text-sm text-gray-600">' + esc(v.impoExpo) + '</td>' +
        '<td class="whitespace-nowrap px-4 py-3 text-sm text-gray-600">' + esc(v.pedimento) + '</td>' +
        '<td class="whitespace-nowrap px-4 py-3 text-sm text-gray-600">' + esc(v.agente) + '</td>' +
        '<td class="whitespace-nowrap px-4 py-3 text-sm text-gray-600">' + esc(v.aduana) + '</td>' +
        '<td class="whitespace-nowrap px-4 py-3 text-sm text-gray-600">' + esc(v.patente) + '</td>' +
        '<td class="px-4 py-3 text-sm text-gray-600 max-w-[180px] truncate" title="' + esc(v.clienteSpace) + '">' + esc(v.clienteSpace) + '</td>' +
        '<td class="whitespace-nowrap px-4 py-3 text-sm text-gray-600">' + esc(v.mes) + '</td>' +
        '<td class="whitespace-nowrap px-4 py-3 text-sm text-gray-600">' + esc(v.estatus) + '</td>' +
        '<td class="whitespace-nowrap px-4 py-3 text-sm text-gray-600">' + esc(v.tipo) + '</td>' +
        '<td class="whitespace-nowrap px-4 py-3 text-sm text-gray-600">' + esc(v.firma) + '</td>' +
        '<td class="whitespace-nowrap px-4 py-3 text-sm text-gray-600">' + esc(fmtFecha(v.fechaPago)) + '</td>' +
        '<td class="whitespace-nowrap px-4 py-3 text-sm text-gray-600">' + esc(v.factura) + '</td>' +
        '<td class="whitespace-nowrap px-4 py-3 text-sm text-gray-600">' + esc(v.plazo) + '</td>';
      tbody.appendChild(tr);
    });
    if (slice.length === 0) sinDatos.classList.remove('hidden');
  }

  function irPagina(n) {
    const total = Math.max(1, Math.ceil(filtrados.length / porPagina));
    pagina = Math.max(1, Math.min(n, total));
    actualizarPaginacion();
  }

  function setupSort() {
    const map = { numero: 'numero', pedimento: 'pedimento', agente: 'agente', aduana: 'aduana', patente: 'patente', proveedor_cliente: 'proveedorCliente', mes: 'mes', estatus: 'estatus', tipo: 'tipo', fecha_pago: 'fechaPago' };
    document.querySelectorAll('#tabla-virtuales th[data-sort]').forEach(th => {
      th.addEventListener('click', () => {
        const col = map[th.dataset.sort] || th.dataset.sort;
        if (sortCol === col) sortAsc = !sortAsc;
        else { sortCol = col; sortAsc = true; }
        aplicarFiltros();
      });
    });
  }

  function init() {
    extraer();
    document.getElementById('busqueda-virtuales').addEventListener('input', aplicarFiltros);
    document.getElementById('btn-limpiar-virtuales').addEventListener('click', () => {
      document.getElementById('busqueda-virtuales').value = '';
      aplicarFiltros();
    });
    document.getElementById('registros-pagina-virtuales').addEventListener('change', (e) => {
      porPagina = parseInt(e.target.value, 10) || 25;
      aplicarFiltros();
    });
    document.getElementById('pagina-actual-virtuales').addEventListener('change', (e) => {
      irPagina(parseInt(e.target.value, 10) || 1);
    });
    ['btn-primera-virtuales', 'btn-anterior-virtuales', 'btn-siguiente-virtuales', 'btn-ultima-virtuales'].forEach((id, i) => {
      document.getElementById(id).addEventListener('click', () => {
        if (i === 0) irPagina(1);
        else if (i === 1) irPagina(pagina - 1);
        else if (i === 2) irPagina(pagina + 1);
        else irPagina(Math.ceil(filtrados.length / porPagina));
      });
    });
    setupSort();
    aplicarFiltros();
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else init();
})();
</script>
{% endblock %}
