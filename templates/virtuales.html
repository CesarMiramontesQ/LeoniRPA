{% extends "base.html" %} {% block content %}
<div class="space-y-6">
  <!-- Header -->
  <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
    <div>
      <h1 class="text-2xl font-semibold text-gray-900">Virtuales</h1>
      <p class="mt-1 text-sm text-gray-600">
        Master unificado de virtuales – consulta de registros
      </p>
    </div>
    <div class="flex items-center gap-2">
      <button
        id="btn-agregar-virtual"
        type="button"
        class="inline-flex items-center rounded-md bg-[#003D89] px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-[#002d66] focus:outline-none focus:ring-2 focus:ring-[#003D89] focus:ring-offset-2"
      >
        <svg class="mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m6-6H6" />
        </svg>
        Nuevo registro
      </button>
    </div>
  </div>

  <!-- Tarjetas informativas -->
  <dl class="grid grid-cols-2 gap-4 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6">
    <!-- Total -->
    <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow-sm sm:p-6">
      <dt class="truncate text-sm font-medium text-gray-500">Total</dt>
      <dd class="mt-1 text-2xl font-semibold tracking-tight text-gray-900">{{ "{:,}".format(total_virtuales) }}</dd>
    </div>
    <!-- Por estatus -->
    {% for estatus, count in estatus_counts.items() %}
    <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow-sm sm:p-6">
      <dt class="truncate text-sm font-medium text-gray-500" title="{{ estatus }}">{{ estatus }}</dt>
      <dd class="mt-1 text-2xl font-semibold tracking-tight text-[#003D89]">{{ "{:,}".format(count) }}</dd>
    </div>
    {% endfor %}
  </dl>

  <!-- Panel de filtros -->
  <div class="rounded-lg bg-white p-6 shadow-sm">
    <div class="flex flex-wrap items-end gap-4">
      <div class="flex-1 min-w-[200px]">
        <label for="busqueda-virtuales" class="block text-sm font-medium text-gray-900">Buscar</label>
        <div class="mt-2">
          <input
            type="text"
            id="busqueda-virtuales"
            placeholder="Número, proveedor/cliente, agente, estatus, tipo, incoterm..."
            class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-[#003D89] sm:text-sm"
          />
        </div>
      </div>
      <div class="flex items-end gap-2">
        <button
          id="btn-limpiar-virtuales"
          type="button"
          class="rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-[#003D89] focus:ring-offset-2"
        >
          Limpiar
        </button>
      </div>
    </div>

    <div class="mt-4 flex flex-wrap items-center gap-4">
      <div class="flex items-center gap-2">
        <label for="registros-pagina-virtuales" class="text-sm text-gray-600">Mostrar</label>
        <select
          id="registros-pagina-virtuales"
          class="rounded-md border border-gray-300 bg-white px-2 py-1 text-sm focus:border-[#003D89] focus:outline-none focus:ring-1 focus:ring-[#003D89]"
        >
          <option value="25">25</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
        <span class="text-sm text-gray-600">por página</span>
      </div>
    </div>
  </div>

  <!-- Tabla -->
  <div class="rounded-lg bg-white shadow-sm">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200" id="tabla-virtuales">
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" class="cursor-pointer px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 hover:bg-gray-100" data-sort="numero">Número</th>
            <th scope="col" class="cursor-pointer px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 hover:bg-gray-100" data-sort="proveedor_cliente">Proveedor/Cliente</th>
            <th scope="col" class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Impo/Expo</th>
            <th scope="col" class="cursor-pointer px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 hover:bg-gray-100" data-sort="agente">Agente</th>
            <th scope="col" class="cursor-pointer px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 hover:bg-gray-100" data-sort="mes">Mes</th>
            <th scope="col" class="cursor-pointer px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 hover:bg-gray-100" data-sort="estatus">Estatus</th>
            <th scope="col" class="cursor-pointer px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 hover:bg-gray-100" data-sort="tipo">Tipo</th>
            <th scope="col" class="cursor-pointer px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 hover:bg-gray-100" data-sort="incoterm">Incoterm</th>
            <th scope="col" class="cursor-pointer px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 hover:bg-gray-100" data-sort="tipo_exportacion">Tipo Exportación</th>
            <th scope="col" class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Plazo</th>
            <th scope="col" class="px-4 py-3 text-center text-xs font-medium uppercase tracking-wider text-gray-500">Acciones</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200 bg-white" id="tabla-virtuales-body">
          <tr id="fila-sin-datos-virtuales">
            <td colspan="11" class="px-6 py-12 text-center text-sm text-gray-500">
              <div class="flex flex-col items-center">
                <svg class="h-12 w-12 text-gray-400 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <p class="font-medium text-gray-500">No hay registros</p>
                <p class="mt-1 text-gray-400">Los datos se mostrarán aquí cuando estén disponibles</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Paginación -->
    <div class="flex flex-wrap items-center justify-between gap-4 border-t border-gray-200 px-4 py-4 sm:px-6">
      <div class="flex items-center gap-2">
        <button
          id="btn-primera-virtuales"
          type="button"
          class="rounded-md border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
          disabled
        >
          <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="m18.75 4.5-7.5 7.5 7.5 7.5m-6-15L5.25 12l7.5 7.5" />
          </svg>
        </button>
        <button
          id="btn-anterior-virtuales"
          type="button"
          class="rounded-md border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
          disabled
        >
          <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
          </svg>
        </button>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-sm text-gray-600">Página</span>
        <input
          type="number"
          id="pagina-actual-virtuales"
          value="1"
          min="1"
          class="w-16 rounded-md border border-gray-300 bg-white px-2 py-1 text-center text-sm focus:border-[#003D89] focus:outline-none focus:ring-1 focus:ring-[#003D89]"
        />
        <span class="text-sm text-gray-600">de <span id="total-paginas-virtuales">1</span></span>
      </div>
      <div class="flex items-center gap-2">
        <button
          id="btn-siguiente-virtuales"
          type="button"
          class="rounded-md border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
          disabled
        >
          <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" />
          </svg>
        </button>
        <button
          id="btn-ultima-virtuales"
          type="button"
          class="rounded-md border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
          disabled
        >
          <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="m5.25 4.5 7.5 7.5-7.5 7.5m6-15 7.5 7.5-7.5 7.5" />
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Datos ocultos -->
<div id="datos-virtuales" style="display: none;">
  {% for v in virtuales %}
  <div
    data-virtual-item
    data-id="{{ v.id or '' }}"
    data-numero="{{ v.numero or '' }}"
    data-agente="{{ v.agente or '' }}"
    data-impo-expo="{{ v.impo_expo or '' }}"
    data-proveedor-cliente="{{ v.proveedor_cliente or '' }}"
    data-mes="{{ v.mes or '' }}"
    data-estatus="{{ v.estatus or '' }}"
    data-tipo="{{ v.tipo or '' }}"
    data-incoterm="{{ v.incoterm or '' }}"
    data-tipo-exportacion="{{ v.tipo_exportacion or '' }}"
    data-plazo="{{ v.plazo or '' }}"
    data-solicitud-previo="{{ 'Sí' if v.solicitud_previo else 'No' }}"
    data-pedimento="{{ v.pedimento or '' }}"
    data-aduana="{{ v.aduana or '' }}"
    data-patente="{{ v.patente or '' }}"
    data-destino="{{ v.destino or '' }}"
    data-cliente-space="{{ v.cliente_space or '' }}"
    data-complemento="{{ v.complemento or '' }}"
    data-tipo-immex="{{ v.tipo_immex or '' }}"
    data-factura="{{ v.factura or '' }}"
    data-fecha-pago="{% if v.fecha_pago %}{{ v.fecha_pago.strftime('%d/%m/%Y') }}{% endif %}"
    data-informacion="{{ v.informacion or '' }}"
    data-op-regular="{{ 'Sí' if v.op_regular else 'No' }}"
    data-carretes="{{ 'Sí' if v.carretes else 'No' }}"
    data-servicio-cliente="{{ v.servicio_cliente or '' }}"
    data-firma="{{ v.firma or '' }}"
  ></div>
  {% endfor %}
</div>

<!-- Modal de detalle -->
<div id="modal-detalle" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <div class="flex min-h-screen items-end justify-center px-4 pt-4 pb-20 text-center sm:block sm:p-0">
    <!-- Fondo oscuro -->
    <div id="modal-backdrop" class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
    
    <!-- Centrar el modal -->
    <span class="hidden sm:inline-block sm:h-screen sm:align-middle" aria-hidden="true">&#8203;</span>
    
    <!-- Contenido del modal -->
    <div class="relative inline-block transform overflow-hidden rounded-lg bg-white text-left align-bottom shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-4xl sm:align-middle">
      <!-- Header del modal -->
      <div class="bg-[#003D89] px-6 py-4">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold text-white" id="modal-title">Detalle del Registro</h3>
          <button id="btn-cerrar-modal" type="button" class="text-white hover:text-gray-200 focus:outline-none">
            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </div>
      
      <!-- Body del modal -->
      <form id="form-editar-virtual">
        <input type="hidden" id="modal-id" name="id" />
        <div class="bg-white px-6 py-4 max-h-[70vh] overflow-y-auto">
          <div class="grid grid-cols-1 gap-x-4 gap-y-4 sm:grid-cols-3">
            <!-- Número (solo lectura) -->
            <div>
              <label for="modal-numero" class="block text-sm/6 font-medium text-gray-900">Número</label>
              <div class="mt-2">
                <input type="text" id="modal-numero" name="numero" readonly class="block w-full rounded-md bg-gray-100 px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 sm:text-sm/6" />
              </div>
            </div>
            <!-- Proveedor/Cliente -->
            <div class="sm:col-span-2">
              <label for="modal-proveedor-cliente" class="block text-sm/6 font-medium text-gray-900">Proveedor/Cliente</label>
              <div class="mt-2">
                <input type="text" id="modal-proveedor-cliente" name="proveedor_cliente" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-[#003D89] sm:text-sm/6" />
              </div>
            </div>
            <!-- Impo/Expo -->
            <div>
              <label for="modal-impo-expo" class="block text-sm/6 font-medium text-gray-900">Impo/Expo</label>
              <div class="mt-2">
                <input type="text" id="modal-impo-expo" name="impo_expo" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-[#003D89] sm:text-sm/6" />
              </div>
            </div>
            <!-- Agente -->
            <div>
              <label for="modal-agente" class="block text-sm/6 font-medium text-gray-900">Agente</label>
              <div class="mt-2">
                <input type="text" id="modal-agente" name="agente" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-[#003D89] sm:text-sm/6" />
              </div>
            </div>
            <!-- Mes -->
            <div>
              <label for="modal-mes" class="block text-sm/6 font-medium text-gray-900">Mes</label>
              <div class="mt-2">
                <input type="text" id="modal-mes" name="mes" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-[#003D89] sm:text-sm/6" />
              </div>
            </div>
            <!-- Estatus -->
            <div>
              <label for="modal-estatus" class="block text-sm/6 font-medium text-gray-900">Estatus</label>
              <div class="mt-2">
                <input type="text" id="modal-estatus" name="estatus" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-[#003D89] sm:text-sm/6" />
              </div>
            </div>
            <!-- Tipo -->
            <div>
              <label for="modal-tipo" class="block text-sm/6 font-medium text-gray-900">Tipo</label>
              <div class="mt-2">
                <input type="text" id="modal-tipo" name="tipo" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-[#003D89] sm:text-sm/6" />
              </div>
            </div>
            <!-- Incoterm -->
            <div>
              <label for="modal-incoterm" class="block text-sm/6 font-medium text-gray-900">Incoterm</label>
              <div class="mt-2">
                <input type="text" id="modal-incoterm" name="incoterm" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-[#003D89] sm:text-sm/6" />
              </div>
            </div>
            <!-- Tipo Exportación -->
            <div class="sm:col-span-3">
              <label for="modal-tipo-exportacion" class="block text-sm/6 font-medium text-gray-900">Tipo Exportación</label>
              <div class="mt-2">
                <input type="text" id="modal-tipo-exportacion" name="tipo_exportacion" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-[#003D89] sm:text-sm/6" />
              </div>
            </div>
            <!-- Plazo -->
            <div>
              <label for="modal-plazo" class="block text-sm/6 font-medium text-gray-900">Plazo</label>
              <div class="mt-2">
                <input type="text" id="modal-plazo" name="plazo" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-[#003D89] sm:text-sm/6" />
              </div>
            </div>
            <!-- Pedimento -->
            <div>
              <label for="modal-pedimento" class="block text-sm/6 font-medium text-gray-900">Pedimento</label>
              <div class="mt-2">
                <input type="text" id="modal-pedimento" name="pedimento" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-[#003D89] sm:text-sm/6" />
              </div>
            </div>
            <!-- Aduana -->
            <div>
              <label for="modal-aduana" class="block text-sm/6 font-medium text-gray-900">Aduana</label>
              <div class="mt-2">
                <input type="text" id="modal-aduana" name="aduana" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-[#003D89] sm:text-sm/6" />
              </div>
            </div>
            <!-- Patente -->
            <div>
              <label for="modal-patente" class="block text-sm/6 font-medium text-gray-900">Patente</label>
              <div class="mt-2">
                <input type="text" id="modal-patente" name="patente" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-[#003D89] sm:text-sm/6" />
              </div>
            </div>
            <!-- Destino -->
            <div>
              <label for="modal-destino" class="block text-sm/6 font-medium text-gray-900">Destino</label>
              <div class="mt-2">
                <input type="text" id="modal-destino" name="destino" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-[#003D89] sm:text-sm/6" />
              </div>
            </div>
            <!-- Cliente Space -->
            <div>
              <label for="modal-cliente-space" class="block text-sm/6 font-medium text-gray-900">Cliente Space</label>
              <div class="mt-2">
                <input type="text" id="modal-cliente-space" name="cliente_space" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-[#003D89] sm:text-sm/6" />
              </div>
            </div>
            <!-- Complemento -->
            <div>
              <label for="modal-complemento" class="block text-sm/6 font-medium text-gray-900">Complemento</label>
              <div class="mt-2">
                <input type="text" id="modal-complemento" name="complemento" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-[#003D89] sm:text-sm/6" />
              </div>
            </div>
            <!-- Tipo IMMEX -->
            <div>
              <label for="modal-tipo-immex" class="block text-sm/6 font-medium text-gray-900">Tipo IMMEX</label>
              <div class="mt-2">
                <input type="text" id="modal-tipo-immex" name="tipo_immex" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-[#003D89] sm:text-sm/6" />
              </div>
            </div>
            <!-- Factura -->
            <div>
              <label for="modal-factura" class="block text-sm/6 font-medium text-gray-900">Factura</label>
              <div class="mt-2">
                <input type="text" id="modal-factura" name="factura" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-[#003D89] sm:text-sm/6" />
              </div>
            </div>
            <!-- Fecha de Pago -->
            <div>
              <label for="modal-fecha-pago" class="block text-sm/6 font-medium text-gray-900">Fecha de Pago</label>
              <div class="mt-2">
                <input type="text" id="modal-fecha-pago" name="fecha_pago" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-[#003D89] sm:text-sm/6" />
              </div>
            </div>
            <!-- Información -->
            <div class="sm:col-span-3">
              <label for="modal-informacion" class="block text-sm/6 font-medium text-gray-900">Información</label>
              <div class="mt-2">
                <textarea id="modal-informacion" name="informacion" rows="2" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-[#003D89] sm:text-sm/6"></textarea>
              </div>
            </div>
            <!-- Servicio Cliente -->
            <div>
              <label for="modal-servicio-cliente" class="block text-sm/6 font-medium text-gray-900">Servicio Cliente</label>
              <div class="mt-2">
                <input type="text" id="modal-servicio-cliente" name="servicio_cliente" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-[#003D89] sm:text-sm/6" />
              </div>
            </div>
            <!-- Firma -->
            <div>
              <label for="modal-firma" class="block text-sm/6 font-medium text-gray-900">Firma</label>
              <div class="mt-2">
                <input type="text" id="modal-firma" name="firma" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-[#003D89] sm:text-sm/6" />
              </div>
            </div>
            <!-- Solicitud Previo -->
            <div>
              <label for="modal-solicitud-previo" class="block text-sm/6 font-medium text-gray-900">Solicitud Previo</label>
              <div class="mt-2">
                <select id="modal-solicitud-previo" name="solicitud_previo" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 focus:outline-2 focus:-outline-offset-2 focus:outline-[#003D89] sm:text-sm/6">
                  <option value="">-</option>
                  <option value="Sí">Sí</option>
                  <option value="No">No</option>
                </select>
              </div>
            </div>
            <!-- OP Regular -->
            <div>
              <label for="modal-op-regular" class="block text-sm/6 font-medium text-gray-900">OP Regular</label>
              <div class="mt-2">
                <select id="modal-op-regular" name="op_regular" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 focus:outline-2 focus:-outline-offset-2 focus:outline-[#003D89] sm:text-sm/6">
                  <option value="">-</option>
                  <option value="Sí">Sí</option>
                  <option value="No">No</option>
                </select>
              </div>
            </div>
            <!-- Carretes -->
            <div>
              <label for="modal-carretes" class="block text-sm/6 font-medium text-gray-900">Carretes</label>
              <div class="mt-2">
                <select id="modal-carretes" name="carretes" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 focus:outline-2 focus:-outline-offset-2 focus:outline-[#003D89] sm:text-sm/6">
                  <option value="">-</option>
                  <option value="Sí">Sí</option>
                  <option value="No">No</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Footer del modal -->
        <div class="bg-gray-50 px-6 py-3 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <button id="btn-eliminar-modal" type="button" class="hidden rounded-md border border-red-600 bg-white px-4 py-2 text-sm font-medium text-red-600 hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
            Eliminar
          </button>
          <div class="flex justify-end gap-3">
            <button id="btn-cerrar-modal-footer" type="button" class="rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-[#003D89] focus:ring-offset-2">
              Cancelar
            </button>
            <button id="btn-guardar-modal" type="submit" class="rounded-md bg-[#003D89] px-4 py-2 text-sm font-medium text-white hover:bg-[#002d66] focus:outline-none focus:ring-2 focus:ring-[#003D89] focus:ring-offset-2">
              Guardar cambios
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
(function() {
  let todos = [];
  let filtrados = [];
  let pagina = 1;
  let porPagina = 25;
  let sortCol = 'numero';
  let sortAsc = true;
  let modoModal = 'edit';
  let registroActual = null;
  const esAdmin = {{ 'true' if current_user.rol|default('')|lower == 'admin' else 'false' }};

  function esc(s) {
    const d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }

  function extraer() {
    const els = document.querySelectorAll('#datos-virtuales [data-virtual-item]');
    todos = [];
    els.forEach(el => {
      todos.push({
        id: el.dataset.id || '',
        numero: el.dataset.numero || '',
        agente: el.dataset.agente || '',
        impoExpo: el.dataset.impoExpo || '',
        proveedorCliente: el.dataset.proveedorCliente || '',
        mes: el.dataset.mes || '',
        estatus: el.dataset.estatus || '',
        tipo: el.dataset.tipo || '',
        incoterm: el.dataset.incoterm || '',
        tipoExportacion: el.dataset.tipoExportacion || '',
        plazo: el.dataset.plazo || '',
        solicitudPrevio: el.dataset.solicitudPrevio || '',
        pedimento: el.dataset.pedimento || '',
        aduana: el.dataset.aduana || '',
        patente: el.dataset.patente || '',
        destino: el.dataset.destino || '',
        clienteSpace: el.dataset.clienteSpace || '',
        complemento: el.dataset.complemento || '',
        tipoImmex: el.dataset.tipoImmex || '',
        factura: el.dataset.factura || '',
        fechaPago: el.dataset.fechaPago || '',
        informacion: el.dataset.informacion || '',
        opRegular: el.dataset.opRegular || '',
        carretes: el.dataset.carretes || '',
        servicioCliente: el.dataset.servicioCliente || '',
        firma: el.dataset.firma || ''
      });
    });
  }

  function cumpleFiltro(v, q) {
    if (!q) return true;
    const t = q.toLowerCase();
    const s = [
      v.numero, v.agente, v.impoExpo, v.proveedorCliente, v.mes,
      v.estatus, v.tipo, v.incoterm, v.tipoExportacion, v.plazo
    ].join(' ').toLowerCase();
    return s.includes(t);
  }

  function aplicarFiltros() {
    const q = (document.getElementById('busqueda-virtuales').value || '').trim();
    filtrados = todos.filter(v => cumpleFiltro(v, q));
    const cmp = (a, b) => {
      let va = a[sortCol] ?? '', vb = b[sortCol] ?? '';
      if (sortCol === 'numero') {
        const na = parseInt(va, 10), nb = parseInt(vb, 10);
        if (!isNaN(na) && !isNaN(nb)) return sortAsc ? na - nb : nb - na;
        va = String(va); vb = String(vb);
      } else {
        va = String(va).toLowerCase();
        vb = String(vb).toLowerCase();
      }
      if (va < vb) return sortAsc ? -1 : 1;
      if (va > vb) return sortAsc ? 1 : -1;
      return 0;
    };
    filtrados.sort(cmp);
    pagina = 1;
    actualizarPaginacion();
  }

  function actualizarPaginacion() {
    const total = filtrados.length;
    const totalPag = Math.max(1, Math.ceil(total / porPagina));
    const from = (pagina - 1) * porPagina;
    const to = Math.min(from + porPagina, total);
    const paginasEl = document.getElementById('total-paginas-virtuales');
    const actualEl = document.getElementById('pagina-actual-virtuales');
    if (paginasEl) paginasEl.textContent = totalPag;
    if (actualEl) { actualEl.value = pagina; actualEl.max = totalPag; }
    const btns = ['btn-primera-virtuales', 'btn-anterior-virtuales', 'btn-siguiente-virtuales', 'btn-ultima-virtuales'];
    btns.forEach(id => {
      const b = document.getElementById(id);
      if (!b) return;
      if (id.includes('primera') || id.includes('anterior')) b.disabled = pagina <= 1;
      else b.disabled = pagina >= totalPag;
    });
    render(from, to);
  }

  function render(from, to) {
    const tbody = document.getElementById('tabla-virtuales-body');
    const sinDatos = document.getElementById('fila-sin-datos-virtuales');
    if (!tbody) return;
    const slice = filtrados.slice(from, to);
    sinDatos.classList.add('hidden');
    const exists = tbody.querySelectorAll('tr:not(#fila-sin-datos-virtuales)');
    exists.forEach(tr => tr.remove());
    slice.forEach((v, idx) => {
      const tr = document.createElement('tr');
      tr.className = 'hover:bg-gray-50';
      tr.innerHTML =
        '<td class="whitespace-nowrap px-4 py-3 text-sm font-medium text-gray-900">' + esc(v.numero) + '</td>' +
        '<td class="px-4 py-3 text-sm text-gray-600 max-w-[200px] truncate" title="' + esc(v.proveedorCliente) + '">' + esc(v.proveedorCliente) + '</td>' +
        '<td class="whitespace-nowrap px-4 py-3 text-sm text-gray-600">' + esc(v.impoExpo) + '</td>' +
        '<td class="whitespace-nowrap px-4 py-3 text-sm text-gray-600">' + esc(v.agente) + '</td>' +
        '<td class="whitespace-nowrap px-4 py-3 text-sm text-gray-600">' + esc(v.mes) + '</td>' +
        '<td class="whitespace-nowrap px-4 py-3 text-sm text-gray-600">' + esc(v.estatus) + '</td>' +
        '<td class="whitespace-nowrap px-4 py-3 text-sm text-gray-600">' + esc(v.tipo) + '</td>' +
        '<td class="whitespace-nowrap px-4 py-3 text-sm text-gray-600">' + esc(v.incoterm) + '</td>' +
        '<td class="px-4 py-3 text-sm text-gray-600 max-w-[200px] truncate" title="' + esc(v.tipoExportacion) + '">' + esc(v.tipoExportacion) + '</td>' +
        '<td class="whitespace-nowrap px-4 py-3 text-sm text-gray-600">' + esc(v.plazo) + '</td>' +
        '<td class="whitespace-nowrap px-4 py-3 text-sm text-center">' +
          '<button type="button" class="btn-ver inline-flex items-center rounded-md bg-[#003D89] px-2.5 py-1.5 text-xs font-medium text-white hover:bg-[#002d66] focus:outline-none focus:ring-2 focus:ring-[#003D89] focus:ring-offset-2" data-index="' + (from + idx) + '">' +
            '<svg class="h-4 w-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.64 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.64 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>' +
            'Ver' +
          '</button>' +
        '</td>';
      tbody.appendChild(tr);
    });
    if (slice.length === 0) sinDatos.classList.remove('hidden');
    
    // Agregar event listeners a los botones Ver
    document.querySelectorAll('.btn-ver').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const index = parseInt(e.currentTarget.dataset.index, 10);
        abrirModal(filtrados[index], 'edit');
      });
    });
  }
  
  function abrirModal(datos = null, modo = 'edit') {
    modoModal = modo;
    const esCreacion = modo === 'create';
    const modal = document.getElementById('modal-detalle');
    const formulario = document.getElementById('form-editar-virtual');
    const titulo = document.getElementById('modal-title');
    const btnGuardar = document.getElementById('btn-guardar-modal');
    const btnEliminar = document.getElementById('btn-eliminar-modal');
    const numeroInput = document.getElementById('modal-numero');
    const vacio = {
      id: '',
      numero: '',
      proveedorCliente: '',
      impoExpo: '',
      agente: '',
      mes: '',
      estatus: '',
      tipo: '',
      incoterm: '',
      tipoExportacion: '',
      plazo: '',
      solicitudPrevio: '',
      pedimento: '',
      aduana: '',
      patente: '',
      destino: '',
      clienteSpace: '',
      complemento: '',
      tipoImmex: '',
      factura: '',
      fechaPago: '',
      informacion: '',
      opRegular: '',
      carretes: '',
      servicioCliente: '',
      firma: ''
    };
    const v = datos || vacio;
    registroActual = esCreacion ? null : datos;
    
    if (esCreacion && formulario) formulario.reset();
    
    if (titulo) titulo.textContent = esCreacion ? 'Nuevo registro' : 'Detalle del Registro';
    if (btnGuardar) btnGuardar.textContent = esCreacion ? 'Crear registro' : 'Guardar cambios';
    if (btnEliminar) {
      if (esAdmin && !esCreacion) btnEliminar.classList.remove('hidden');
      else btnEliminar.classList.add('hidden');
    }
    
    if (numeroInput) {
      numeroInput.readOnly = !esCreacion;
      numeroInput.classList.toggle('bg-gray-100', !esCreacion);
      numeroInput.classList.toggle('bg-white', esCreacion);
      numeroInput.value = v.numero || '';
    }
    
    // Llenar los datos del modal (inputs)
    document.getElementById('modal-id').value = v.id || '';
    document.getElementById('modal-proveedor-cliente').value = v.proveedorCliente || '';
    document.getElementById('modal-impo-expo').value = v.impoExpo || '';
    document.getElementById('modal-agente').value = v.agente || '';
    document.getElementById('modal-mes').value = v.mes || '';
    document.getElementById('modal-estatus').value = v.estatus || '';
    document.getElementById('modal-tipo').value = v.tipo || '';
    document.getElementById('modal-incoterm').value = v.incoterm || '';
    document.getElementById('modal-tipo-exportacion').value = v.tipoExportacion || '';
    document.getElementById('modal-plazo').value = v.plazo || '';
    document.getElementById('modal-pedimento').value = v.pedimento || '';
    document.getElementById('modal-aduana').value = v.aduana || '';
    document.getElementById('modal-patente').value = v.patente || '';
    document.getElementById('modal-destino').value = v.destino || '';
    document.getElementById('modal-cliente-space').value = v.clienteSpace || '';
    document.getElementById('modal-complemento').value = v.complemento || '';
    document.getElementById('modal-tipo-immex').value = v.tipoImmex || '';
    document.getElementById('modal-factura').value = v.factura || '';
    document.getElementById('modal-fecha-pago').value = v.fechaPago || '';
    document.getElementById('modal-informacion').value = v.informacion || '';
    document.getElementById('modal-servicio-cliente').value = v.servicioCliente || '';
    document.getElementById('modal-firma').value = v.firma || '';
    
    // Selects (booleanos)
    document.getElementById('modal-solicitud-previo').value = v.solicitudPrevio || '';
    document.getElementById('modal-op-regular').value = v.opRegular || '';
    document.getElementById('modal-carretes').value = v.carretes || '';
    
    // Mostrar el modal
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }
  
  function cerrarModal() {
    const modal = document.getElementById('modal-detalle');
    modal.classList.add('hidden');
    document.body.style.overflow = '';
    modoModal = 'edit';
    registroActual = null;
  }

  function irPagina(n) {
    const total = Math.max(1, Math.ceil(filtrados.length / porPagina));
    pagina = Math.max(1, Math.min(n, total));
    actualizarPaginacion();
  }

  function setupSort() {
    const map = { numero: 'numero', agente: 'agente', proveedor_cliente: 'proveedorCliente', mes: 'mes', estatus: 'estatus', tipo: 'tipo', incoterm: 'incoterm', tipo_exportacion: 'tipoExportacion' };
    document.querySelectorAll('#tabla-virtuales th[data-sort]').forEach(th => {
      th.addEventListener('click', () => {
        const col = map[th.dataset.sort] || th.dataset.sort;
        if (sortCol === col) sortAsc = !sortAsc;
        else { sortCol = col; sortAsc = true; }
        aplicarFiltros();
      });
    });
  }

  async function eliminarRegistro() {
    if (!esAdmin || modoModal !== 'edit') return;
    const numeroValor = (document.getElementById('modal-numero').value || '').trim();
    const numeroInt = parseInt(numeroValor, 10);
    if (!numeroValor || Number.isNaN(numeroInt)) {
      alert('No se puede eliminar: número inválido');
      return;
    }
    
    const detalle = prompt(`Describe el motivo para eliminar el registro ${numeroInt} (obligatorio):`);
    if (!detalle || !detalle.trim()) {
      alert('Debes proporcionar un detalle para continuar.');
      return;
    }
    
    const confirmar = confirm(`¿Eliminar el registro ${numeroInt}? Esta acción no se puede deshacer.`);
    if (!confirmar) return;
    
    const btnEliminar = document.getElementById('btn-eliminar-modal');
    const textoOriginal = btnEliminar.textContent;
    btnEliminar.disabled = true;
    btnEliminar.textContent = 'Eliminando...';
    
    try {
      const response = await fetch(`/api/virtuales/${numeroInt}`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ detalle: detalle.trim() })
      });
      let result = {};
      try {
        result = await response.json();
      } catch (_) {
        result = {};
      }
      if (response.ok && result.success) {
        alert('Registro eliminado correctamente');
        window.location.reload();
      } else {
        alert('Error: ' + (result.error || result.message || 'No se pudo eliminar el registro'));
      }
    } catch (error) {
      console.error('Error al eliminar:', error);
      alert('Error al conectar con el servidor');
    } finally {
      btnEliminar.disabled = false;
      btnEliminar.textContent = textoOriginal;
    }
  }

  function init() {
    extraer();
    const btnAgregar = document.getElementById('btn-agregar-virtual');
    if (btnAgregar) {
      btnAgregar.addEventListener('click', () => abrirModal(null, 'create'));
    }
    const btnEliminar = document.getElementById('btn-eliminar-modal');
    if (btnEliminar) {
      btnEliminar.addEventListener('click', eliminarRegistro);
    }
    document.getElementById('busqueda-virtuales').addEventListener('input', aplicarFiltros);
    document.getElementById('btn-limpiar-virtuales').addEventListener('click', () => {
      document.getElementById('busqueda-virtuales').value = '';
      aplicarFiltros();
    });
    document.getElementById('registros-pagina-virtuales').addEventListener('change', (e) => {
      porPagina = parseInt(e.target.value, 10) || 25;
      aplicarFiltros();
    });
    document.getElementById('pagina-actual-virtuales').addEventListener('change', (e) => {
      irPagina(parseInt(e.target.value, 10) || 1);
    });
    ['btn-primera-virtuales', 'btn-anterior-virtuales', 'btn-siguiente-virtuales', 'btn-ultima-virtuales'].forEach((id, i) => {
      document.getElementById(id).addEventListener('click', () => {
        if (i === 0) irPagina(1);
        else if (i === 1) irPagina(pagina - 1);
        else if (i === 2) irPagina(pagina + 1);
        else irPagina(Math.ceil(filtrados.length / porPagina));
      });
    });
    
    // Event listeners para cerrar el modal
    document.getElementById('btn-cerrar-modal').addEventListener('click', cerrarModal);
    document.getElementById('btn-cerrar-modal-footer').addEventListener('click', cerrarModal);
    document.getElementById('modal-backdrop').addEventListener('click', cerrarModal);
    
    // Cerrar modal con tecla Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const modal = document.getElementById('modal-detalle');
        if (!modal.classList.contains('hidden')) {
          cerrarModal();
        }
      }
    });
    
    // Event listener para guardar cambios
    document.getElementById('form-editar-virtual').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const numeroValor = (document.getElementById('modal-numero').value || '').trim();
      if (!numeroValor) {
        alert('No se puede guardar: el número es requerido');
        return;
      }
      
      const numeroInt = parseInt(numeroValor, 10);
      if (Number.isNaN(numeroInt)) {
        alert('No se puede guardar: el número debe ser numérico');
        return;
      }
      
      const esCreacion = modoModal === 'create';
      const btnGuardar = document.getElementById('btn-guardar-modal');
      const textoOriginal = btnGuardar.textContent;
      btnGuardar.disabled = true;
      btnGuardar.textContent = 'Guardando...';
      
      // Recopilar datos del formulario
      const datos = {
        proveedor_cliente: document.getElementById('modal-proveedor-cliente').value,
        impo_expo: document.getElementById('modal-impo-expo').value,
        agente: document.getElementById('modal-agente').value,
        mes: document.getElementById('modal-mes').value,
        estatus: document.getElementById('modal-estatus').value,
        tipo: document.getElementById('modal-tipo').value,
        incoterm: document.getElementById('modal-incoterm').value,
        tipo_exportacion: document.getElementById('modal-tipo-exportacion').value,
        plazo: document.getElementById('modal-plazo').value,
        pedimento: document.getElementById('modal-pedimento').value,
        aduana: document.getElementById('modal-aduana').value,
        patente: document.getElementById('modal-patente').value,
        destino: document.getElementById('modal-destino').value,
        cliente_space: document.getElementById('modal-cliente-space').value,
        complemento: document.getElementById('modal-complemento').value,
        tipo_immex: document.getElementById('modal-tipo-immex').value,
        factura: document.getElementById('modal-factura').value,
        fecha_pago: document.getElementById('modal-fecha-pago').value,
        informacion: document.getElementById('modal-informacion').value,
        servicio_cliente: document.getElementById('modal-servicio-cliente').value,
        firma: document.getElementById('modal-firma').value,
        solicitud_previo: document.getElementById('modal-solicitud-previo').value,
        op_regular: document.getElementById('modal-op-regular').value,
        carretes: document.getElementById('modal-carretes').value
      };
      if (esCreacion) {
        datos.numero = numeroInt;
      }
      
      try {
        const response = await fetch(esCreacion ? '/api/virtuales' : `/api/virtuales/${numeroInt}`, {
          method: esCreacion ? 'POST' : 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(datos)
        });
        
        let result = {};
        try {
          result = await response.json();
        } catch (_) {
          result = {};
        }
        
        if (response.ok && result.success) {
          alert(esCreacion ? 'Registro creado correctamente' : 'Registro actualizado correctamente');
          // Recargar la página para reflejar los cambios
          window.location.reload();
        } else {
          alert('Error: ' + (result.error || result.message || 'No se pudo procesar el registro'));
        }
      } catch (error) {
        console.error('Error al guardar:', error);
        alert('Error al conectar con el servidor');
      } finally {
        btnGuardar.disabled = false;
        btnGuardar.textContent = textoOriginal;
      }
    });
    
    setupSort();
    aplicarFiltros();
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else init();
})();
</script>
{% endblock %}
