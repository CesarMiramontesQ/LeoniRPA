{% extends "base.html" %} {% block content %}
<div class="space-y-6">
  <!-- Header -->
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-semibold text-gray-900">Registros de Ventas</h1>
      <p class="mt-1 text-sm text-gray-600">
        Visualiza y gestiona todas las ventas registradas en el sistema
      </p>
    </div>
  </div>

  <!-- Tarjetas de Estadísticas -->
  <div>
    <dl class="grid grid-cols-1 gap-5 sm:grid-cols-1">
      <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow-sm sm:p-6">
        <dt class="truncate text-sm font-medium text-gray-500">Total de Ventas Registradas</dt>
        <dd class="mt-1 text-3xl font-semibold tracking-tight text-gray-900" id="total-ventas">{{ total_ventas }}</dd>
      </div>
    </dl>
  </div>

  <!-- Panel de Filtros -->
  <div class="rounded-lg bg-white p-6 shadow-sm">
    <div class="space-y-4">
      <div class="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3">
        <div>
          <label for="busqueda-general" class="block text-sm/6 font-medium text-gray-900">Buscar</label>
          <div class="mt-2">
            <input
              type="text"
              id="busqueda-general"
              placeholder="Buscar por cliente, producto, planta..."
              class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-[#003D89] sm:text-sm/6"
            />
          </div>
        </div>
        <div>
          <label for="cliente" class="block text-sm/6 font-medium text-gray-900">Cliente</label>
          <div class="mt-2">
            <input
              type="text"
              id="cliente"
              placeholder="Filtrar por cliente"
              class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-[#003D89] sm:text-sm/6"
            />
          </div>
        </div>
        <div>
          <label for="codigo-cliente" class="block text-sm/6 font-medium text-gray-900">Código Cliente</label>
          <div class="mt-2">
            <input
              type="number"
              id="codigo-cliente"
              placeholder="Filtrar por código de cliente"
              class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-[#003D89] sm:text-sm/6"
            />
          </div>
        </div>
        <div>
          <label for="periodo-inicio" class="block text-sm/6 font-medium text-gray-900">Período Inicio</label>
          <div class="mt-2">
            <input
              type="date"
              id="periodo-inicio"
              class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-[#003D89] sm:text-sm/6"
            />
          </div>
        </div>
        <div>
          <label for="periodo-fin" class="block text-sm/6 font-medium text-gray-900">Período Fin</label>
          <div class="mt-2">
            <input
              type="date"
              id="periodo-fin"
              class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-[#003D89] sm:text-sm/6"
            />
          </div>
        </div>
        <div>
          <label for="producto" class="block text-sm/6 font-medium text-gray-900">Producto</label>
          <div class="mt-2">
            <input
              type="text"
              id="producto"
              placeholder="Filtrar por producto"
              class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-[#003D89] sm:text-sm/6"
            />
          </div>
        </div>
        <div>
          <label for="planta" class="block text-sm/6 font-medium text-gray-900">Planta</label>
          <div class="mt-2">
            <input
              type="text"
              id="planta"
              placeholder="Filtrar por planta"
              class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-[#003D89] sm:text-sm/6"
            />
          </div>
        </div>
      </div>
      <div class="flex items-end">
        <button
          id="btn-limpiar-filtros"
          type="button"
          class="rounded-md border border-gray-300 bg-white px-4 py-1.5 text-sm font-medium text-gray-700 hover:bg-gray-50"
        >
          Limpiar Filtros
        </button>
      </div>
    </div>
  </div>

  <!-- Tabla de Ventas -->
  <div class="rounded-lg bg-white shadow-sm">
    <!-- Encabezado de la tabla con información y controles -->
    <div class="flex items-center justify-between border-b border-gray-200 px-6 py-4">
      <div class="flex items-center gap-4">
        <span class="text-sm text-gray-600">
          Mostrando <span id="registros-mostrados" class="font-medium">0</span> de <span id="total-registros" class="font-medium">0</span> ventas
        </span>
      </div>
      <div class="flex items-center gap-4">
        <!-- Selector de registros por página -->
        <div class="flex items-center gap-2">
          <label for="registros-por-pagina" class="text-sm text-gray-600">Mostrar:</label>
          <select
            id="registros-por-pagina"
            class="rounded-md border border-gray-300 bg-white px-2 py-1 text-sm focus:border-[#003D89] focus:outline-none focus:ring-1 focus:ring-[#003D89]"
          >
            <option value="10">10</option>
            <option value="25" selected>25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Tabla -->
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200" id="tabla-ventas">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Cliente</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Código Cliente</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Grupo</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Período</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Producto</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Planta</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Sales KM</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Turnover w/o metal</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Precio Exmetal KM</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200 bg-white" id="tabla-ventas-body">
          <!-- Los datos se cargarán aquí dinámicamente -->
        </tbody>
      </table>
    </div>

    <!-- Paginación -->
    <div class="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6">
      <div class="flex flex-1 justify-between sm:hidden">
        <button
          id="btn-pagina-anterior-mobile"
          class="relative inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Anterior
        </button>
        <button
          id="btn-pagina-siguiente-mobile"
          class="relative ml-3 inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Siguiente
        </button>
      </div>
      <div class="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
        <div>
          <p class="text-sm text-gray-700">
            Página <span id="pagina-actual" class="font-medium">1</span> de <span id="total-paginas" class="font-medium">1</span>
          </p>
        </div>
        <div>
          <nav class="isolate inline-flex -space-x-px rounded-md shadow-sm" aria-label="Pagination">
            <button
              id="btn-primera-pagina"
              class="relative inline-flex items-center rounded-l-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <span class="sr-only">Primera</span>
              <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M15.79 14.77a.75.75 0 01-1.06.02l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 111.04 1.08L11.832 10l3.938 3.71a.75.75 0 01.02 1.06zm-6 0a.75.75 0 01-1.06.02l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 111.04 1.08L5.832 10l3.938 3.71a.75.75 0 01.02 1.06z" clip-rule="evenodd" />
              </svg>
            </button>
            <button
              id="btn-pagina-anterior"
              class="relative inline-flex items-center px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <span class="sr-only">Anterior</span>
              <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" />
              </svg>
            </button>
            <button
              id="btn-pagina-siguiente"
              class="relative inline-flex items-center px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <span class="sr-only">Siguiente</span>
              <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
              </svg>
            </button>
            <button
              id="btn-ultima-pagina"
              class="relative inline-flex items-center rounded-r-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <span class="sr-only">Última</span>
              <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M10.21 14.77a.75.75 0 01.02-1.06L14.168 10 10.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02zm-6 0a.75.75 0 01.02-1.06L8.168 10 4.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
              </svg>
            </button>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Variables de estado
  let todasLasVentas = [];
  let ventasFiltradas = [];
  let paginaActual = 1;
  let registrosPorPagina = 25;
  let timeoutBusqueda = null;
  let totalVentasReal = {{ total_ventas }}; // Total real desde el servidor

  // Inicialización
  document.addEventListener('DOMContentLoaded', function() {
    cargarVentas();
    configurarEventos();
  });

  async function cargarVentas() {
    try {
      const params = new URLSearchParams();
      params.append('limit', '50000'); // Límite alto para obtener todos los que coincidan con los filtros
      const search = document.getElementById('busqueda-general').value.trim();
      const cliente = document.getElementById('cliente').value.trim();
      const codigoCliente = document.getElementById('codigo-cliente').value.trim();
      const periodoInicio = document.getElementById('periodo-inicio').value;
      const periodoFin = document.getElementById('periodo-fin').value;
      const producto = document.getElementById('producto').value.trim();
      const planta = document.getElementById('planta').value.trim();
      if (search) params.append('search', search);
      if (cliente) params.append('cliente', cliente);
      if (codigoCliente) params.append('codigo_cliente', codigoCliente);
      if (periodoInicio) params.append('periodo_inicio', periodoInicio);
      if (periodoFin) params.append('periodo_fin', periodoFin);
      if (producto) params.append('producto', producto);
      if (planta) params.append('planta', planta);

      const response = await fetch(`/api/ventas?${params.toString()}`);
      const data = await response.json();

      if (response.ok) {
        todasLasVentas = data.ventas || [];
        totalVentasReal = data.total !== undefined ? data.total : todasLasVentas.length;
        // Cuando se usan filtros en la API, los datos ya vienen filtrados; si no hay filtros, total es el del servidor
        if (!search && !cliente && !codigoCliente && !periodoInicio && !periodoFin && !producto && !planta && data.total !== undefined) {
          totalVentasReal = data.total;
        }
        ventasFiltradas = todasLasVentas;
        paginaActual = 1;
        renderizarTabla();
        actualizarContadores();
      } else {
        console.error('Error al cargar ventas:', data.error);
      }
    } catch (error) {
      console.error('Error al cargar ventas:', error);
    }
  }

  function configurarEventos() {
    // Al cambiar cualquier filtro, recargar desde la API con esos filtros (así se obtienen todos los registros que coinciden)
    function programarRecarga() {
      clearTimeout(timeoutBusqueda);
      timeoutBusqueda = setTimeout(cargarVentas, 400);
    }
    document.getElementById('busqueda-general').addEventListener('input', programarRecarga);
    document.getElementById('cliente').addEventListener('input', programarRecarga);
    document.getElementById('codigo-cliente').addEventListener('input', programarRecarga);
    document.getElementById('periodo-inicio').addEventListener('change', programarRecarga);
    document.getElementById('periodo-fin').addEventListener('change', programarRecarga);
    document.getElementById('producto').addEventListener('input', programarRecarga);
    document.getElementById('planta').addEventListener('input', programarRecarga);

    // Limpiar filtros y recargar
    document.getElementById('btn-limpiar-filtros').addEventListener('click', function() {
      document.getElementById('busqueda-general').value = '';
      document.getElementById('cliente').value = '';
      document.getElementById('codigo-cliente').value = '';
      document.getElementById('periodo-inicio').value = '';
      document.getElementById('periodo-fin').value = '';
      document.getElementById('producto').value = '';
      document.getElementById('planta').value = '';
      cargarVentas();
    });
    
    // Registros por página
    document.getElementById('registros-por-pagina').addEventListener('change', function() {
      registrosPorPagina = parseInt(this.value);
      paginaActual = 1;
      renderizarTabla();
      actualizarContadores();
    });
    
    // Paginación
    document.getElementById('btn-primera-pagina').addEventListener('click', () => irAPagina(1));
    document.getElementById('btn-pagina-anterior').addEventListener('click', () => irAPagina(paginaActual - 1));
    document.getElementById('btn-pagina-siguiente').addEventListener('click', () => irAPagina(paginaActual + 1));
    document.getElementById('btn-ultima-pagina').addEventListener('click', () => {
      const totalPaginas = Math.ceil(ventasFiltradas.length / registrosPorPagina) || 1;
      irAPagina(totalPaginas);
    });
    
    // Paginación móvil
    document.getElementById('btn-pagina-anterior-mobile').addEventListener('click', () => irAPagina(paginaActual - 1));
    document.getElementById('btn-pagina-siguiente-mobile').addEventListener('click', () => irAPagina(paginaActual + 1));
  }

  function aplicarFiltros() {
    const busqueda = document.getElementById('busqueda-general').value.toLowerCase();
    const cliente = document.getElementById('cliente').value.toLowerCase();
    const codigoCliente = document.getElementById('codigo-cliente').value;
    const periodoInicio = document.getElementById('periodo-inicio').value;
    const periodoFin = document.getElementById('periodo-fin').value;
    const producto = document.getElementById('producto').value.toLowerCase();
    const planta = document.getElementById('planta').value.toLowerCase();
    
    ventasFiltradas = todasLasVentas.filter(venta => {
      // Búsqueda general
      if (busqueda) {
        const matchBusqueda = 
          (venta.cliente && venta.cliente.toLowerCase().includes(busqueda)) ||
          (venta.producto && venta.producto.toLowerCase().includes(busqueda)) ||
          (venta.descripcion_producto && venta.descripcion_producto.toLowerCase().includes(busqueda)) ||
          (venta.planta && venta.planta.toLowerCase().includes(busqueda));
        if (!matchBusqueda) return false;
      }
      
      // Filtro por cliente
      if (cliente && (!venta.cliente || !venta.cliente.toLowerCase().includes(cliente))) {
        return false;
      }
      
      // Filtro por código de cliente
      if (codigoCliente && venta.codigo_cliente !== parseInt(codigoCliente)) {
        return false;
      }
      
      // Filtro por período
      if (periodoInicio && venta.periodo && venta.periodo < periodoInicio) {
        return false;
      }
      if (periodoFin && venta.periodo && venta.periodo > periodoFin) {
        return false;
      }
      
      // Filtro por producto
      if (producto && (!venta.producto || !venta.producto.toLowerCase().includes(producto))) {
        return false;
      }
      
      // Filtro por planta
      if (planta && (!venta.planta || !venta.planta.toLowerCase().includes(planta))) {
        return false;
      }
      
      return true;
    });
    
    paginaActual = 1;
    renderizarTabla();
    actualizarContadores();
  }

  /** Formatea periodo YYYY-MM-DD a mes/año en es-MX sin desfase por zona horaria. */
  function formatearPeriodo(periodo) {
    if (!periodo) return '-';
    const d = new Date(periodo + 'T12:00:00');
    return d.toLocaleDateString('es-MX', { year: 'numeric', month: '2-digit' });
  }

  function renderizarTabla() {
    const tbody = document.getElementById('tabla-ventas-body');
    const inicio = (paginaActual - 1) * registrosPorPagina;
    const fin = inicio + registrosPorPagina;
    const ventasPagina = ventasFiltradas.slice(inicio, fin);
    
    if (ventasPagina.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="9" class="px-6 py-4 text-center text-sm text-gray-500">
            No se encontraron ventas
          </td>
        </tr>
      `;
      return;
    }
    
    tbody.innerHTML = ventasPagina.map(venta => `
      <tr class="hover:bg-gray-50">
        <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-900">${venta.cliente || '-'}</td>
        <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-500">${venta.codigo_cliente || '-'}</td>
        <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-500">${venta.grupo || '-'}</td>
        <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-500">${formatearPeriodo(venta.periodo)}</td>
        <td class="px-6 py-4 text-sm text-gray-900">
          <div class="max-w-xs truncate" title="${venta.producto || ''}">${venta.producto || '-'}</div>
        </td>
        <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-500">${venta.planta || '-'}</td>
        <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-500">${venta.sales_km ? venta.sales_km.toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '-'}</td>
        <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-500">${venta.turnover_wo_metal ? venta.turnover_wo_metal.toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '-'}</td>
        <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-500">${venta.precio_exmetal_km ? venta.precio_exmetal_km.toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '-'}</td>
      </tr>
    `).join('');
  }

  function actualizarContadores() {
    const inicio = Math.min((paginaActual - 1) * registrosPorPagina + 1, ventasFiltradas.length);
    const fin = Math.min(paginaActual * registrosPorPagina, ventasFiltradas.length);
    
    document.getElementById('registros-mostrados').textContent = ventasFiltradas.length > 0 ? `${inicio}-${fin}` : '0';
    document.getElementById('total-registros').textContent = ventasFiltradas.length;
    // Usar el total real del servidor, no solo los registros cargados
    document.getElementById('total-ventas').textContent = totalVentasReal.toLocaleString('es-MX');
    
    actualizarPaginacion();
  }

  function actualizarPaginacion() {
    const totalPaginas = Math.max(1, Math.ceil(ventasFiltradas.length / registrosPorPagina));
    
    document.getElementById('pagina-actual').textContent = paginaActual;
    document.getElementById('total-paginas').textContent = totalPaginas;

    // Habilitar/deshabilitar botones
    document.getElementById('btn-primera-pagina').disabled = paginaActual === 1;
    document.getElementById('btn-pagina-anterior').disabled = paginaActual === 1;
    document.getElementById('btn-pagina-siguiente').disabled = paginaActual >= totalPaginas;
    document.getElementById('btn-ultima-pagina').disabled = paginaActual >= totalPaginas;
    document.getElementById('btn-pagina-anterior-mobile').disabled = paginaActual === 1;
    document.getElementById('btn-pagina-siguiente-mobile').disabled = paginaActual >= totalPaginas;
  }

  function irAPagina(pagina) {
    const totalPaginas = Math.ceil(ventasFiltradas.length / registrosPorPagina);
    if (pagina >= 1 && pagina <= totalPaginas) {
      paginaActual = pagina;
      renderizarTabla();
      actualizarContadores();
    }
  }
</script>
{% endblock %}
