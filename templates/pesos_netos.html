{% extends "base.html" %} {% block content %}
<div class="space-y-6">
  <div class="flex flex-wrap items-center justify-between gap-4">
    <div>
      <h1 class="text-2xl font-semibold text-gray-900">Pesos Netos</h1>
      <p class="mt-1 text-sm text-gray-600">
        Consulta de pesos por número de parte (gross, net y kgm).
      </p>
    </div>
  </div>

  <dl class="grid grid-cols-1 gap-5 sm:grid-cols-1">
    <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow-sm sm:p-6">
      <dt class="truncate text-sm font-medium text-gray-500">Total de registros</dt>
      <dd class="mt-1 text-3xl font-semibold tracking-tight text-gray-900">{{ "{:,}".format(total_pesos_netos) }}</dd>
    </div>
  </dl>

  <div class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
    <div class="flex flex-wrap items-end gap-3">
      <div class="min-w-[260px] flex-1">
        <label for="peso-search" class="block text-sm font-medium text-gray-900">Buscar</label>
        <input
          id="peso-search"
          type="text"
          placeholder="Número de parte o descripción..."
          class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-1.5 text-sm focus:border-[#003D89] focus:outline-none focus:ring-1 focus:ring-[#003D89]"
        />
      </div>
      <div>
        <label for="peso-limit" class="block text-sm font-medium text-gray-900">Límite</label>
        <select id="peso-limit" class="mt-1 rounded-md border border-gray-300 px-2 py-1.5 text-sm focus:border-[#003D89] focus:outline-none focus:ring-1 focus:ring-[#003D89]">
          <option value="25" selected>25</option>
          <option value="50">50</option>
          <option value="100">100</option>
          <option value="200">200</option>
        </select>
      </div>
      <button
        id="peso-recargar"
        type="button"
        class="rounded-md border border-gray-300 bg-white px-4 py-1.5 text-sm font-medium text-gray-700 hover:bg-gray-50"
      >
        Recargar
      </button>
    </div>

    <p id="peso-msg" class="mt-3 text-xs text-gray-500">Cargando registros...</p>

    <div class="mt-3 overflow-x-auto rounded border border-gray-200">
      <table class="min-w-full text-sm">
        <thead class="bg-gray-50">
          <tr class="border-b text-left text-gray-500">
            <th class="px-3 py-2">Número de parte</th>
            <th class="px-3 py-2">Descripción</th>
            <th class="px-3 py-2">Gross</th>
            <th class="px-3 py-2">Net</th>
            <th class="px-3 py-2">KGM</th>
            <th class="px-3 py-2">Actualizado</th>
          </tr>
        </thead>
        <tbody id="peso-body"></tbody>
      </table>
    </div>

    <div class="mt-3 flex items-center justify-between gap-3">
      <p id="peso-page-text" class="text-xs text-gray-500">Página 1 de 1</p>
      <div class="flex items-center gap-2">
        <button id="peso-prev" type="button" class="rounded-md border border-gray-300 bg-white px-3 py-1.5 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50">
          Anterior
        </button>
        <button id="peso-next" type="button" class="rounded-md border border-gray-300 bg-white px-3 py-1.5 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50">
          Siguiente
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  (function () {
    const inputSearch = document.getElementById('peso-search');
    const inputLimit = document.getElementById('peso-limit');
    const btnRecargar = document.getElementById('peso-recargar');
    const tbody = document.getElementById('peso-body');
    const msg = document.getElementById('peso-msg');
    const pageText = document.getElementById('peso-page-text');
    const btnPrev = document.getElementById('peso-prev');
    const btnNext = document.getElementById('peso-next');

    let currentPage = 1;

    function esc(value) {
      if (value === null || value === undefined) return '';
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function fmtNum(value) {
      if (value === null || value === undefined || value === '') return '—';
      const n = Number(value);
      if (!Number.isFinite(n)) return esc(value);
      return n.toLocaleString('es-MX', { maximumFractionDigits: 6 });
    }

    function fmtDate(value) {
      if (!value) return '—';
      const d = new Date(value);
      if (Number.isNaN(d.getTime())) return '—';
      return d.toLocaleString('es-MX');
    }

    async function cargar(resetPage) {
      if (resetPage) currentPage = 1;
      const limit = Math.min(200, Math.max(1, parseInt(inputLimit.value || '25', 10)));
      const offset = (currentPage - 1) * limit;
      const q = inputSearch.value.trim();

      msg.textContent = 'Cargando registros...';
      try {
        const params = new URLSearchParams({ limit: String(limit), offset: String(offset) });
        if (q) params.set('q', q);
        const res = await fetch('/api/pesos-netos?' + params.toString(), { credentials: 'same-origin' });
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error(data.mensaje || 'Error al cargar datos');

        const total = Number(data.total || 0);
        const totalPages = Math.max(1, Math.ceil(total / limit));
        if (currentPage > totalPages) {
          currentPage = totalPages;
          return cargar(false);
        }

        const rows = Array.isArray(data.rows) ? data.rows : [];
        if (!rows.length) {
          tbody.innerHTML = '<tr><td colspan="6" class="px-3 py-3 text-gray-400">Sin resultados</td></tr>';
        } else {
          tbody.innerHTML = rows.map(function (r) {
            return '<tr class="border-b border-gray-100">' +
              '<td class="px-3 py-2 font-mono text-gray-900">' + esc(r.numero_parte) + '</td>' +
              '<td class="px-3 py-2 text-gray-700">' + esc(r.descripcion || '') + '</td>' +
              '<td class="px-3 py-2 text-gray-700">' + fmtNum(r.gross) + '</td>' +
              '<td class="px-3 py-2 text-gray-700">' + fmtNum(r.net) + '</td>' +
              '<td class="px-3 py-2 text-gray-700">' + fmtNum(r.kgm) + '</td>' +
              '<td class="px-3 py-2 text-gray-500">' + fmtDate(r.updated_at) + '</td>' +
            '</tr>';
          }).join('');
        }

        const shown = rows.length;
        const from = total === 0 ? 0 : offset + 1;
        const to = offset + shown;
        msg.textContent = 'Mostrando ' + from + '-' + to + ' de ' + total + ' registros.';
        pageText.textContent = 'Página ' + currentPage + ' de ' + totalPages;
        btnPrev.disabled = currentPage <= 1;
        btnNext.disabled = currentPage >= totalPages;
      } catch (e) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-3 py-3 text-red-600">Error al cargar datos</td></tr>';
        msg.textContent = 'Error: ' + (e.message || e);
        pageText.textContent = 'Página 1 de 1';
        btnPrev.disabled = true;
        btnNext.disabled = true;
      }
    }

    let debounceTimer = null;
    inputSearch.addEventListener('input', function () {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(function () { cargar(true); }, 300);
    });
    inputLimit.addEventListener('change', function () { cargar(true); });
    btnRecargar.addEventListener('click', function () { cargar(false); });
    btnPrev.addEventListener('click', function () {
      if (currentPage <= 1) return;
      currentPage -= 1;
      cargar(false);
    });
    btnNext.addEventListener('click', function () {
      currentPage += 1;
      cargar(false);
    });

    cargar(true);
  })();
</script>
{% endblock %}
