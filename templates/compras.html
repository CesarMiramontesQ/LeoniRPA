{% extends "base.html" %} {% block content %}
<div class="space-y-6">
  <!-- Header -->
  <div>
    <h1 class="text-2xl font-semibold text-gray-900">
      Descargar Compras del Mes
    </h1>
  </div>

  <!-- Grid principal: Parámetros y Estado del Proceso en primera fila -->
  <div class="space-y-6">
    <!-- Primera fila: Seleccionar Parámetros (descarga + procesamiento automático) -->
    <div class="grid grid-cols-1 gap-6">
      <!-- Panel: Seleccionar Parámetros -->
      <div>
        <div class="rounded-lg bg-white p-6 shadow-sm">
          <h2 class="mb-4 text-lg font-medium text-gray-900">
            Seleccionar Parámetros
          </h2>

        <div class="space-y-4">
          <!-- Rango de fechas -->
          <div>
            <label class="block text-sm/6 font-medium text-gray-900"
              >Rango de fechas</label
            >
            <div class="mt-2 flex gap-2">
              <div class="flex-1">
                <label for="fecha-inicio" class="block text-sm/6 font-medium text-gray-900">Fecha inicio</label>
                <div class="mt-2">
                  <div class="flex rounded-md bg-white outline-1 -outline-offset-1 outline-gray-300 focus-within:outline-2 focus-within:-outline-offset-2 focus-within:outline-[#003D89]">
                    <input
                      type="date"
                      id="fecha-inicio"
                      class="block min-w-0 grow px-3 py-1.5 text-base text-gray-900 placeholder:text-gray-400 focus:outline-none sm:text-sm/6"
                    />
                  </div>
                </div>
              </div>
              <div class="flex-1">
                <label for="fecha-fin" class="block text-sm/6 font-medium text-gray-900">Fecha fin</label>
                <div class="mt-2">
                  <div class="flex rounded-md bg-white outline-1 -outline-offset-1 outline-gray-300 focus-within:outline-2 focus-within:-outline-offset-2 focus-within:outline-[#003D89]">
                    <input
                      type="date"
                      id="fecha-fin"
                      class="block min-w-0 grow px-3 py-1.5 text-base text-gray-900 placeholder:text-gray-400 focus:outline-none sm:text-sm/6"
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Botones de acción -->
          <div class="flex flex-wrap gap-3 pt-4">
            <button
              id="btn-iniciar-descarga"
              type="button"
              class="rounded-md bg-[#003D89] px-4 py-2 text-sm font-medium text-white hover:bg-[#003070] disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Iniciar descarga
            </button>
            <button
              id="btn-limpiar"
              type="button"
              class="rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
            >
              Limpiar
            </button>
            <button
              class="rounded-md border border-gray-300 bg-white p-2 text-gray-700 hover:bg-gray-50"
            >
              <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                <path
                  d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"
                />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Segunda fila: Registro de Actividad -->
    <div>
      <div class="rounded-lg bg-white p-6 shadow-sm">
        <h2 class="mb-4 text-lg font-medium text-gray-900">
          Registro de Actividad (Últimos 5)
        </h2>

        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th
                  class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider text-gray-500"
                >
                  Fecha
                </th>
                <th
                  class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider text-gray-500"
                >
                  Periodo
                </th>
                <th
                  class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider text-gray-500"
                >
                  Estado
                </th>
                <th
                  class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider text-gray-500"
                >
                  Usuario
                </th>
                <th
                  class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider text-gray-500"
                >
                  Detalles
                </th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 bg-white" id="tabla-ejecuciones-body">
              {% if executions %}
                {% for exec in executions %}
                <tr>
                  <td class="whitespace-nowrap px-3 py-2 text-sm text-gray-900">
                    {{ exec.created_at | datetime_cdmx('%d/%m/%Y %H:%M') }}
                  </td>
                  <td class="whitespace-nowrap px-3 py-2 text-sm text-gray-500">
                    {{ exec.fecha_inicio_periodo | datetime_cdmx('%d/%m/%Y') }} - 
                    {{ exec.fecha_fin_periodo | datetime_cdmx('%d/%m/%Y') }}
                  </td>
                  <td class="whitespace-nowrap px-3 py-2 text-sm">
                    {% if exec.estado.value == 'SUCCESS' %}
                      <span class="inline-flex rounded-full bg-green-100 px-2 py-1 text-xs font-medium text-green-800">
                        Éxito
                      </span>
                    {% elif exec.estado.value == 'FAILED' %}
                      <span class="inline-flex rounded-full bg-red-100 px-2 py-1 text-xs font-medium text-red-800">
                        Fallido
                      </span>
                    {% elif exec.estado.value == 'RUNNING' %}
                      <span class="inline-flex rounded-full bg-blue-100 px-2 py-1 text-xs font-medium text-blue-800">
                        En ejecución
                      </span>
                    {% elif exec.estado.value == 'PENDING' %}
                      <span class="inline-flex rounded-full bg-yellow-100 px-2 py-1 text-xs font-medium text-yellow-800">
                        Pendiente
                      </span>
                    {% elif exec.estado.value == 'CANCELLED' %}
                      <span class="inline-flex rounded-full bg-gray-100 px-2 py-1 text-xs font-medium text-gray-800">
                        Cancelado
                      </span>
                    {% else %}
                      <span class="inline-flex rounded-full bg-gray-100 px-2 py-1 text-xs font-medium text-gray-800">
                        {{ exec.estado.value }}
                      </span>
                    {% endif %}
                  </td>
                  <td class="whitespace-nowrap px-3 py-2 text-sm text-gray-900">
                    {{ exec.user.email if exec.user else 'N/A' }}
                  </td>
                  <td class="px-3 py-2 text-sm text-gray-600 max-w-xs">
                    {% if exec.detalles %}
                      <span class="line-clamp-2" title="{{ exec.detalles }}">{{ exec.detalles[:80] }}{% if exec.detalles|length > 80 %}...{% endif %}</span>
                      <button type="button" class="mt-1 text-[#003D89] hover:underline text-xs font-medium ver-detalles-btn" data-detalles="{{ exec.detalles|e }}">Ver detalles</button>
                    {% else %}
                      —
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="5" class="px-3 py-4 text-center text-sm text-gray-500">
                    No hay ejecuciones registradas
                  </td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Procesando / Proceso terminado -->
<div id="modal-descarga-compras" class="fixed inset-0 z-50 hidden" aria-hidden="true">
  <div class="fixed inset-0 bg-gray-500/75 transition-opacity" aria-hidden="true"></div>
  <div class="fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="relative w-full max-w-sm rounded-lg bg-white shadow-xl">
      <div class="p-6 text-center">
        <div id="modal-descarga-spinner" class="mx-auto mb-4 flex h-12 w-12 items-center justify-center rounded-full bg-[#003D89]/10">
          <svg class="h-6 w-6 animate-spin text-[#003D89]" fill="none" viewBox="0 0 24 24" aria-hidden="true">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </div>
        <h3 id="modal-descarga-titulo" class="text-lg font-semibold text-gray-900">Procesando</h3>
        <p id="modal-descarga-mensaje" class="mt-2 text-sm text-gray-600">Descargando compras desde SAP. No cierre la ventana de SAP hasta que finalice.</p>
        <div id="modal-descarga-ok" class="mt-6 hidden">
          <button type="button" id="modal-descarga-btn-cerrar" class="rounded-md bg-[#003D89] px-4 py-2 text-sm font-medium text-white hover:bg-[#003070]">
            Cerrar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Ver detalles de ejecución -->
<div id="modal-detalles-ejecucion" class="fixed inset-0 z-50 hidden" aria-hidden="true">
  <div class="fixed inset-0 bg-gray-500/75 transition-opacity" aria-hidden="true"></div>
  <div class="fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="relative w-full max-w-lg rounded-lg bg-white shadow-xl">
      <div class="p-6">
        <h3 class="text-lg font-semibold text-gray-900">Detalles del registro</h3>
        <p id="modal-detalles-texto" class="mt-3 text-sm text-gray-600 whitespace-pre-wrap"></p>
        <div class="mt-4 flex justify-end">
          <button type="button" id="modal-detalles-btn-cerrar" class="rounded-md bg-[#003D89] px-4 py-2 text-sm font-medium text-white hover:bg-[#003070]">Cerrar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Ver detalles de ejecución (registro de actividad)
  document.querySelectorAll('.ver-detalles-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var texto = this.getAttribute('data-detalles') || '';
      document.getElementById('modal-detalles-texto').textContent = texto;
      document.getElementById('modal-detalles-ejecucion').classList.remove('hidden');
    });
  });
  document.getElementById('modal-detalles-btn-cerrar').addEventListener('click', function() {
    document.getElementById('modal-detalles-ejecucion').classList.add('hidden');
  });

  // Funcionalidad para limpiar el formulario
  document.getElementById('btn-limpiar').addEventListener('click', function() {
    // Limpiar inputs de fecha
    document.getElementById('fecha-inicio').value = '';
    document.getElementById('fecha-fin').value = '';
  });
  
  // Modal de descarga: referencias
  const modalDescarga = document.getElementById('modal-descarga-compras');
  const modalDescargaSpinner = document.getElementById('modal-descarga-spinner');
  const modalDescargaTitulo = document.getElementById('modal-descarga-titulo');
  const modalDescargaMensaje = document.getElementById('modal-descarga-mensaje');
  const modalDescargaOk = document.getElementById('modal-descarga-ok');
  const modalDescargaBtnCerrar = document.getElementById('modal-descarga-btn-cerrar');

  function mostrarModalProcesando() {
    modalDescarga.classList.remove('hidden');
    modalDescargaTitulo.textContent = 'Procesando';
    modalDescargaMensaje.textContent = 'Descargando compras desde SAP. No cierre la ventana de SAP hasta que finalice.';
    modalDescargaSpinner.classList.remove('hidden');
    modalDescargaOk.classList.add('hidden');
  }

  function mostrarModalTerminado(titulo, mensaje) {
    modalDescargaTitulo.textContent = titulo;
    modalDescargaMensaje.textContent = mensaje;
    modalDescargaSpinner.classList.add('hidden');
    modalDescargaOk.classList.remove('hidden');
  }

  function cerrarModalDescarga() {
    modalDescarga.classList.add('hidden');
    window.location.reload();
  }

  modalDescargaBtnCerrar.addEventListener('click', cerrarModalDescarga);

  // Funcionalidad para iniciar descarga
  document.getElementById('btn-iniciar-descarga').addEventListener('click', async function() {
    const btn = document.getElementById('btn-iniciar-descarga');
    const fechaInicio = document.getElementById('fecha-inicio').value;
    const fechaFin = document.getElementById('fecha-fin').value;
    
    if (!fechaInicio || !fechaFin) {
      alert('Por favor, selecciona las fechas de inicio y fin del periodo');
      return;
    }
    
    btn.disabled = true;
    const textoOriginal = btn.textContent;
    btn.textContent = 'Iniciando...';
    mostrarModalProcesando();
    
    try {
      const formData = new FormData();
      formData.append('fecha_inicio', fechaInicio);
      formData.append('fecha_fin', fechaFin);
      formData.append('carpeta_salida', 'C:\\Users\\anad5004\\Documents\\Leoni_RPA');
      
      const response = await fetch('/api/compras/iniciar-descarga', {
        method: 'POST',
        body: formData
      });
      
      const data = await response.json();
      
      if (response.ok && data.success) {
        let mensaje = data.message || ('La descarga desde SAP finalizó correctamente. Archivos: ' + (data.archivo_esperado || '') + '. Carpeta: C:\\Users\\anad5004\\Documents\\Leoni_RPA');
        if (data.procesamiento_automatico && data.procesamiento_error) {
          mensaje += '\n\nProcesamiento automático: ' + data.procesamiento_error;
        } else if (data.procesamiento_automatico && (data.insertados !== undefined || data.actualizados !== undefined)) {
          mensaje += '\n\nProcesamiento automático: ' + (data.insertados || 0) + ' insertados, ' + (data.actualizados || 0) + ' actualizados.';
        }
        mostrarModalTerminado('Proceso terminado', mensaje);
      } else {
        mostrarModalTerminado('Error', data.error || 'Error desconocido al iniciar la descarga.');
      }
    } catch (error) {
      console.error('Error al iniciar descarga:', error);
      mostrarModalTerminado('Error', 'No se pudo conectar con el servidor. Por favor, intenta nuevamente.');
    } finally {
      btn.disabled = false;
      btn.textContent = textoOriginal;
    }
  });
</script>
{% endblock %}
