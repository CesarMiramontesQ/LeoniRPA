{% extends "base.html" %} {% block content %}
<div class="space-y-6">
  <!-- Header -->
  <div class="flex flex-wrap items-center justify-between gap-4">
    <div>
      <h1 class="text-2xl font-semibold text-gray-900">Actualizar BOMs</h1>
      <p class="mt-1 text-sm text-gray-600">
        Ejecuta el script SAP (bom.vbs) por cada número de parte, descarga el BOM y actualiza la base de datos.
      </p>
    </div>
    <div class="flex items-center gap-3">
      <label class="flex items-center gap-2 text-sm text-gray-600">
        <span>Límite (opcional):</span>
        <input type="number" id="bom-limit" min="1" placeholder="Todas" class="rounded-md border border-gray-300 px-2 py-1.5 text-sm w-24" />
      </label>
      <button type="button" id="btn-actualizar-boms" class="shrink-0 rounded-md bg-[#003D89] px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-[#003366] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[#003D89] disabled:opacity-50">
        Actualizar
      </button>
      <button type="button" id="btn-parar-boms" class="hidden shrink-0 rounded-md border border-red-600 bg-white px-4 py-2 text-sm font-semibold text-red-600 shadow-sm hover:bg-red-50 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-red-600">
        Parar
      </button>
    </div>
  </div>

  <!-- Estado / resultado -->
  <div id="bom-estado" class="hidden rounded-lg bg-white p-4 shadow-sm">
    <p id="bom-estado-texto" class="text-gray-600"></p>
    <div id="bom-progreso" class="mt-3 hidden">
      <p class="text-sm text-gray-500">Progreso: <span id="bom-progreso-n">0</span> / <span id="bom-progreso-total">0</span> — <span id="bom-progreso-con">0</span> insertados, <span id="bom-progreso-sin">0</span> sin cambios, <span id="bom-progreso-err">0</span> errores</p>
      <div id="bom-log" class="mt-2 max-h-48 overflow-y-auto rounded border border-gray-200 bg-gray-50 p-2 font-mono text-xs"></div>
    </div>
  </div>
  <div id="bom-resultado" class="hidden rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
    <h3 class="text-lg font-semibold text-gray-900">Resumen de la actualización</h3>
    <dl class="mt-4 grid grid-cols-2 gap-4 sm:grid-cols-5">
      <div>
        <dt class="text-sm text-gray-500">Total partes</dt>
        <dd id="res-total" class="text-2xl font-semibold text-gray-900">0</dd>
      </div>
      <div>
        <dt class="text-sm text-gray-500">Procesados</dt>
        <dd id="res-procesados" class="text-2xl font-semibold text-green-700">0</dd>
      </div>
      <div>
        <dt class="text-sm text-gray-500">Con cambios</dt>
        <dd id="res-con-cambios" class="text-2xl font-semibold text-blue-700">0</dd>
      </div>
      <div>
        <dt class="text-sm text-gray-500">Sin cambios</dt>
        <dd id="res-sin-cambios" class="text-2xl font-semibold text-gray-600">0</dd>
      </div>
      <div>
        <dt class="text-sm text-gray-500">Errores</dt>
        <dd id="res-errores" class="text-2xl font-semibold text-red-700">0</dd>
      </div>
    </dl>
    <p id="res-mensaje" class="mt-2 text-sm text-gray-600"></p>
    <details class="mt-4">
      <summary class="cursor-pointer text-sm font-medium text-[#003D89] hover:underline">Ver detalle por parte</summary>
      <div class="mt-2 max-h-64 overflow-y-auto rounded border border-gray-200 p-2 text-sm">
        <table class="min-w-full">
          <thead>
            <tr class="border-b text-left text-gray-500">
              <th class="py-1 pr-4">Nº parte</th>
              <th class="py-1 pr-4">Estado</th>
              <th class="py-1">Mensaje</th>
            </tr>
          </thead>
          <tbody id="res-detalle"></tbody>
        </table>
      </div>
    </details>
  </div>

  <!-- Vista rápida de tablas BD -->
  <div class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <h3 class="text-lg font-semibold text-gray-900">Datos en base de datos (últimos registros)</h3>
      <div class="flex items-center gap-2">
        <label class="text-sm text-gray-600">
          Nº parte:
          <input type="text" id="db-parte-no" placeholder="Ej: 85D00029M" class="ml-1 w-44 rounded-md border border-gray-300 px-2 py-1 text-sm" />
        </label>
        <label class="text-sm text-gray-600">
          Límite:
          <input type="number" id="db-limit" min="1" max="200" value="20" class="ml-1 w-20 rounded-md border border-gray-300 px-2 py-1 text-sm" />
        </label>
        <button type="button" id="btn-recargar-tablas" class="rounded-md border border-gray-300 bg-white px-3 py-1.5 text-sm font-medium text-gray-700 hover:bg-gray-50">
          Recargar tablas
        </button>
      </div>
    </div>
    <p id="db-tablas-msg" class="mt-2 text-xs text-gray-500">Cargando...</p>

    <details class="mt-4" open>
      <summary class="cursor-pointer text-sm font-medium text-[#003D89] hover:underline">Tabla partes</summary>
      <div class="mt-2 max-h-56 overflow-y-auto rounded border border-gray-200 p-2 text-xs">
        <table class="min-w-full">
          <thead><tr class="border-b text-left text-gray-500"><th class="py-1 pr-3">id</th><th class="py-1 pr-3">numero_parte</th><th class="py-1 pr-3">descripcion</th><th class="py-1 pr-3">valido</th><th class="py-1">created_at</th></tr></thead>
          <tbody id="db-partes-body"></tbody>
        </table>
      </div>
    </details>

    <details class="mt-3">
      <summary class="cursor-pointer text-sm font-medium text-[#003D89] hover:underline">Tabla bom</summary>
      <div class="mt-2 max-h-56 overflow-y-auto rounded border border-gray-200 p-2 text-xs">
        <table class="min-w-full">
          <thead><tr class="border-b text-left text-gray-500"><th class="py-1 pr-3">id</th><th class="py-1 pr-3">parte_id</th><th class="py-1 pr-3">parte_no</th><th class="py-1 pr-3">plant</th><th class="py-1 pr-3">usage</th><th class="py-1 pr-3">alternative</th><th class="py-1 pr-3">base_qty</th><th class="py-1">updated_at</th></tr></thead>
          <tbody id="db-bom-body"></tbody>
        </table>
      </div>
    </details>

    <details class="mt-3">
      <summary class="cursor-pointer text-sm font-medium text-[#003D89] hover:underline">Tabla bom_revision</summary>
      <div class="mt-2 max-h-56 overflow-y-auto rounded border border-gray-200 p-2 text-xs">
        <table class="min-w-full">
          <thead><tr class="border-b text-left text-gray-500"><th class="py-1 pr-3">id</th><th class="py-1 pr-3">bom_id</th><th class="py-1 pr-3">parte_no</th><th class="py-1 pr-3">revision_no</th><th class="py-1 pr-3">effective_from</th><th class="py-1 pr-3">effective_to</th><th class="py-1">created_at</th></tr></thead>
          <tbody id="db-bom-rev-body"></tbody>
        </table>
      </div>
    </details>

    <details class="mt-3">
      <summary class="cursor-pointer text-sm font-medium text-[#003D89] hover:underline">Tabla bom_item</summary>
      <div class="mt-2 max-h-56 overflow-y-auto rounded border border-gray-200 p-2 text-xs">
        <table class="min-w-full">
          <thead><tr class="border-b text-left text-gray-500"><th class="py-1 pr-3">id</th><th class="py-1 pr-3">bom_revision_id</th><th class="py-1 pr-3">parte_no</th><th class="py-1 pr-3">componente_id</th><th class="py-1 pr-3">item_no</th><th class="py-1 pr-3">qty</th><th class="py-1">created_at</th></tr></thead>
          <tbody id="db-bom-item-body"></tbody>
        </table>
      </div>
    </details>
  </div>

  <!-- Tarjetas de estadísticas -->
  <dl class="grid grid-cols-1 gap-5 sm:grid-cols-2">
    <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow-sm sm:p-6">
      <dt class="truncate text-sm font-medium text-gray-500">Cantidad de números de parte</dt>
      <dd class="mt-1 text-3xl font-semibold tracking-tight text-gray-900">{{ "{:,}".format(cantidad_numeros_parte) }}</dd>
    </div>
    <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow-sm sm:p-6">
      <dt class="truncate text-sm font-medium text-gray-500">Última actualización</dt>
      <dd class="mt-1 text-3xl font-semibold tracking-tight text-gray-900">{{ ultima_actualizacion }}</dd>
    </div>
  </dl>

  <!-- Ayuda -->
  <div class="rounded-lg bg-white p-6 shadow-sm">
    <h3 class="text-sm font-semibold text-gray-900">Requisitos</h3>
    <ul class="mt-2 list-inside list-disc text-sm text-gray-600">
      <li><strong>La aplicación (uvicorn) debe estar corriendo en la misma PC y la misma sesión de Windows donde tienes SAP GUI abierto.</strong> Si el servidor corre en otro equipo, el script no podrá conectar con SAP.</li>
      <li>SAP GUI instalado, con una sesión abierta (el script usa la primera ventana disponible).</li>
      <li>Carpeta de exportación configurada (<code class="rounded bg-gray-100 px-1">BOM_EXPORT_DIR</code> o la ruta por defecto). Debe existir en disco.</li>
      <li>Opcional: <code class="rounded bg-gray-100 px-1">BOM_VBS_PATH</code> (ruta a bom.vbs) y <code class="rounded bg-gray-100 px-1">BOM_VBS_TIMEOUT_SEC</code> (segundos por parte).</li>
    </ul>
    <p class="mt-2 text-sm text-amber-700">Si al pulsar Actualizar no pasa nada en SAP, revisa el detalle por parte al finalizar: ahí aparecerá el error del script (p. ej. &quot;ActiveX component can't create object&quot; si SAP no está accesible).</p>
  </div>
</div>

<script>
(function() {
  const btn = document.getElementById('btn-actualizar-boms');
  const btnParar = document.getElementById('btn-parar-boms');
  const estado = document.getElementById('bom-estado');
  const estadoTexto = document.getElementById('bom-estado-texto');
  const resultado = document.getElementById('bom-resultado');
  const limitInput = document.getElementById('bom-limit');
  const progresoDiv = document.getElementById('bom-progreso');
  const logDiv = document.getElementById('bom-log');
  const progN = document.getElementById('bom-progreso-n');
  const progTotal = document.getElementById('bom-progreso-total');
  const progCon = document.getElementById('bom-progreso-con');
  const progSin = document.getElementById('bom-progreso-sin');
  const progErr = document.getElementById('bom-progreso-err');
  const dbParteNoInput = document.getElementById('db-parte-no');
  const dbLimitInput = document.getElementById('db-limit');
  const btnRecargarTablas = document.getElementById('btn-recargar-tablas');
  const dbMsg = document.getElementById('db-tablas-msg');
  let abortController = null;

  function addLog(line, clase) {
    const p = document.createElement('p');
    p.className = clase || 'text-gray-700';
    p.textContent = line;
    logDiv.appendChild(p);
    logDiv.scrollTop = logDiv.scrollHeight;
  }

  function esc(value) {
    if (value === null || value === undefined) return '';
    return String(value)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function renderRows(bodyId, rows, cols) {
    const tbody = document.getElementById(bodyId);
    if (!tbody) return;
    tbody.innerHTML = '';
    if (!rows || rows.length === 0) {
      tbody.innerHTML = '<tr><td colspan="' + cols.length + '" class="py-2 text-gray-400">Sin datos</td></tr>';
      return;
    }
    rows.forEach(function(row) {
      const tr = document.createElement('tr');
      tr.className = 'border-b border-gray-100';
      tr.innerHTML = cols.map(function(c) {
        return '<td class="py-1 pr-3">' + esc(row[c]) + '</td>';
      }).join('');
      tbody.appendChild(tr);
    });
  }

  async function cargarTablasDb() {
    const parteNo = dbParteNoInput && dbParteNoInput.value ? dbParteNoInput.value.trim() : '';
    const limit = dbLimitInput && dbLimitInput.value ? parseInt(dbLimitInput.value, 10) : 20;
    const safeLimit = Number.isFinite(limit) && limit > 0 ? Math.min(limit, 200) : 20;
    dbMsg.textContent = 'Cargando tablas...';
    try {
      const params = new URLSearchParams({ limit: String(safeLimit) });
      if (parteNo) params.set('parte_no', parteNo);
      const res = await fetch('/api/actualizar-boms/tablas?' + params.toString(), { credentials: 'same-origin' });
      const data = await res.json();
      if (!res.ok || !data.ok) throw new Error(data.mensaje || 'Error al consultar tablas');

      renderRows('db-partes-body', data.partes || [], ['id', 'numero_parte', 'descripcion', 'valido', 'created_at']);
      renderRows('db-bom-body', data.bom || [], ['id', 'parte_id', 'parte_no', 'plant', 'usage', 'alternative', 'base_qty', 'updated_at']);
      renderRows('db-bom-rev-body', data.bom_revision || [], ['id', 'bom_id', 'parte_no', 'revision_no', 'effective_from', 'effective_to', 'created_at']);
      renderRows('db-bom-item-body', data.bom_item || [], ['id', 'bom_revision_id', 'parte_no', 'componente_id', 'item_no', 'qty', 'created_at']);
      dbMsg.textContent = 'Tablas cargadas. Mostrando últimos ' + safeLimit + ' registros por tabla' + (parteNo ? (' para parte ' + parteNo) : '') + '.';
    } catch (e) {
      dbMsg.textContent = 'Error al cargar tablas: ' + (e.message || e);
    }
  }

  btn.addEventListener('click', async function() {
    abortController = new AbortController();
    btn.disabled = true;
    btnParar.classList.remove('hidden');
    estado.classList.remove('hidden');
    resultado.classList.add('hidden');
    progresoDiv.classList.add('hidden');
    logDiv.innerHTML = '';
    estadoTexto.textContent = 'Ejecutando actualización (verás cada registro en tiempo real)...';
    estado.classList.add('bg-blue-50');
    estado.classList.remove('bg-red-50');

    const limit = limitInput.value.trim() ? parseInt(limitInput.value, 10) : null;
    const url = limit != null && limit > 0
      ? '/api/actualizar-boms/ejecutar-actualizacion-stream?limit=' + limit
      : '/api/actualizar-boms/ejecutar-actualizacion-stream';

    let con = 0, sin = 0, err = 0, n = 0, total = 0;

    function finProceso() {
      btn.disabled = false;
      btnParar.classList.add('hidden');
      abortController = null;
    }

    try {
      const res = await fetch(url, { method: 'POST', credentials: 'same-origin', signal: abortController.signal });
      if (!res.ok) {
        const data = await res.json().catch(function() { return {}; });
        estadoTexto.textContent = data.mensaje || 'Error al ejecutar la actualización.';
        estado.classList.add('bg-red-50');
        estado.classList.remove('bg-blue-50');
        finProceso();
        return;
      }
      progresoDiv.classList.remove('hidden');
      progTotal.textContent = '?';

      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';
      while (true) {
        var chunk = await reader.read();
        if (chunk.done) break;
        buffer += decoder.decode(chunk.value, { stream: true });
        var lines = buffer.split('\n');
        buffer = lines.pop() || '';
        for (var i = 0; i < lines.length; i++) {
          var line = lines[i].trim();
          if (!line) continue;
          try {
            var data = JSON.parse(line);
            if (data.tipo === 'error') {
              estadoTexto.textContent = data.mensaje || 'Error';
              estado.classList.add('bg-red-50');
              break;
            }
            if (data.tipo === 'inicio') {
              total = data.total || 0;
              progTotal.textContent = total;
              addLog('Total a procesar: ' + total, 'text-gray-600');
              continue;
            }
            if (data.tipo === 'parte_inicio') {
              estadoTexto.textContent = 'Procesando parte: ' + (data.parte_no || '');
              addLog((data.parte_no || '') + ' — Ejecutando SAP...', 'text-blue-700');
              continue;
            }
            if (data.tipo === 'parte') {
              n++;
              progN.textContent = n;
              if (data.estado === 'actualizado') {
                con++;
                progCon.textContent = con;
                addLog(data.parte_no + ' — Insertado en BD (' + (data.items_insertados != null ? data.items_insertados + ' items' : '') + ')', 'text-green-700');
              } else if (data.estado === 'sin_cambios') {
                sin++;
                progSin.textContent = sin;
                addLog(data.parte_no + ' — Ya existía (omitido)', 'text-gray-600');
              } else {
                err++;
                progErr.textContent = err;
                addLog(data.parte_no + ' — Error: ' + (data.mensaje || ''), 'text-red-700');
              }
              continue;
            }
            if (data.tipo === 'fin') {
              finProceso();
              estado.classList.add('hidden');
              resultado.classList.remove('hidden');
              document.getElementById('res-total').textContent = data.total ?? 0;
              document.getElementById('res-procesados').textContent = data.procesados ?? 0;
              document.getElementById('res-con-cambios').textContent = data.con_cambios ?? 0;
              document.getElementById('res-sin-cambios').textContent = data.sin_cambios ?? 0;
              document.getElementById('res-errores').textContent = data.errores ?? 0;
              document.getElementById('res-mensaje').textContent = 'Procesados ' + data.procesados + '/' + data.total + '; con cambios: ' + data.con_cambios + ', sin cambios: ' + data.sin_cambios + ', errores: ' + data.errores;
              var tbody = document.getElementById('res-detalle');
              tbody.innerHTML = '';
              (data.detalle || []).forEach(function(row) {
                var tr = document.createElement('tr');
                tr.className = 'border-b border-gray-100';
                tr.innerHTML = '<td class="py-1 pr-4 font-mono text-gray-800">' + (row.parte_no || '') + '</td><td class="py-1 pr-4">' + (row.estado || '') + '</td><td class="py-1 text-gray-600">' + (row.mensaje || '') + '</td>';
                tbody.appendChild(tr);
              });
              await cargarTablasDb();
              break;
            }
          } catch (parseErr) {
            addLog('Linea no JSON: ' + line.substring(0, 80), 'text-amber-700');
          }
        }
      }
    } catch (e) {
      if (e.name === 'AbortError') {
        estadoTexto.textContent = 'Proceso detenido por el usuario.';
        if (logDiv && logDiv.innerHTML) addLog('— Detenido.', 'text-amber-700');
      } else {
        estadoTexto.textContent = 'Error de conexión: ' + e.message;
      }
      estado.classList.add('bg-red-50');
      estado.classList.remove('bg-blue-50');
      finProceso();
    }
  });

  btnParar.addEventListener('click', function() {
    if (abortController) abortController.abort();
  });

  btnRecargarTablas.addEventListener('click', function() {
    cargarTablasDb();
  });
  dbParteNoInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') cargarTablasDb();
  });

  cargarTablasDb();
})();
</script>
{% endblock %}
