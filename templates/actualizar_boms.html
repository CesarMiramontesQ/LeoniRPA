{% extends "base.html" %} {% block content %}
<div class="space-y-6">
  <!-- Header -->
  <div class="flex flex-wrap items-center justify-between gap-4">
    <div>
      <h1 class="text-2xl font-semibold text-gray-900">Actualizar BOMs</h1>
      <p class="mt-1 text-sm text-gray-600">
        Ejecuta el script SAP (bom.vbs) por cada número de parte, descarga el BOM y actualiza la base de datos.
      </p>
    </div>
    <div class="flex items-center gap-3">
      <label class="flex items-center gap-2 text-sm text-gray-600">
        <span>Límite (opcional):</span>
        <input type="number" id="bom-limit" min="1" placeholder="Todas" class="rounded-md border border-gray-300 px-2 py-1.5 text-sm w-24" />
      </label>
      <button type="button" id="btn-actualizar-boms" class="shrink-0 rounded-md bg-[#003D89] px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-[#003366] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[#003D89] disabled:opacity-50">
        Actualizar
      </button>
      <button type="button" id="btn-parar-boms" class="hidden shrink-0 rounded-md border border-red-600 bg-white px-4 py-2 text-sm font-semibold text-red-600 shadow-sm hover:bg-red-50 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-red-600">
        Parar
      </button>
    </div>
  </div>

  <!-- Estado / resultado -->
  <div id="bom-estado" class="hidden rounded-lg bg-white p-4 shadow-sm">
    <p id="bom-estado-texto" class="text-gray-600"></p>
    <div id="bom-progreso" class="mt-3 hidden">
      <p class="text-sm text-gray-500">Progreso: <span id="bom-progreso-n">0</span> / <span id="bom-progreso-total">0</span> — <span id="bom-progreso-con">0</span> insertados, <span id="bom-progreso-sin">0</span> sin cambios, <span id="bom-progreso-err">0</span> errores</p>
      <div id="bom-log" class="mt-2 max-h-48 overflow-y-auto rounded border border-gray-200 bg-gray-50 p-2 font-mono text-xs"></div>
    </div>
  </div>
  <div id="bom-resultado" class="hidden rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
    <h3 class="text-lg font-semibold text-gray-900">Resumen de la actualización</h3>
    <dl class="mt-4 grid grid-cols-2 gap-4 sm:grid-cols-5">
      <div>
        <dt class="text-sm text-gray-500">Total partes</dt>
        <dd id="res-total" class="text-2xl font-semibold text-gray-900">0</dd>
      </div>
      <div>
        <dt class="text-sm text-gray-500">Procesados</dt>
        <dd id="res-procesados" class="text-2xl font-semibold text-green-700">0</dd>
      </div>
      <div>
        <dt class="text-sm text-gray-500">Con cambios</dt>
        <dd id="res-con-cambios" class="text-2xl font-semibold text-blue-700">0</dd>
      </div>
      <div>
        <dt class="text-sm text-gray-500">Sin cambios</dt>
        <dd id="res-sin-cambios" class="text-2xl font-semibold text-gray-600">0</dd>
      </div>
      <div>
        <dt class="text-sm text-gray-500">Errores</dt>
        <dd id="res-errores" class="text-2xl font-semibold text-red-700">0</dd>
      </div>
    </dl>
    <p id="res-mensaje" class="mt-2 text-sm text-gray-600"></p>
    <details class="mt-4">
      <summary class="cursor-pointer text-sm font-medium text-[#003D89] hover:underline">Ver detalle por parte</summary>
      <div class="mt-2 max-h-64 overflow-y-auto rounded border border-gray-200 p-2 text-sm">
        <table class="min-w-full">
          <thead>
            <tr class="border-b text-left text-gray-500">
              <th class="py-1 pr-4">Nº parte</th>
              <th class="py-1 pr-4">Estado</th>
              <th class="py-1">Mensaje</th>
            </tr>
          </thead>
          <tbody id="res-detalle"></tbody>
        </table>
      </div>
    </details>
  </div>

  <!-- Tarjetas de estadísticas -->
  <dl class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
    <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow-sm sm:p-6">
      <dt class="truncate text-sm font-medium text-gray-500">Cantidad de números de parte</dt>
      <dd class="mt-1 text-3xl font-semibold tracking-tight text-gray-900">{{ "{:,}".format(cantidad_numeros_parte) }}</dd>
    </div>
    <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow-sm sm:p-6">
      <dt class="truncate text-sm font-medium text-gray-500">Números de parte con BOM</dt>
      <dd class="mt-1 text-3xl font-semibold tracking-tight text-blue-700">{{ "{:,}".format(numeros_parte_con_bom) }}</dd>
    </div>
    <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow-sm sm:p-6">
      <dt class="truncate text-sm font-medium text-gray-500">Números de parte no válidos</dt>
      <dd class="mt-1 text-3xl font-semibold tracking-tight text-red-700">{{ "{:,}".format(numeros_parte_no_validos) }}</dd>
    </div>
    <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow-sm sm:p-6">
      <dt class="truncate text-sm font-medium text-gray-500">Última actualización</dt>
      <dd class="mt-1 text-3xl font-semibold tracking-tight text-gray-900">{{ ultima_actualizacion }}</dd>
    </div>
  </dl>

  <!-- Tabla de partes con modal de detalle -->
  <div class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <h3 class="text-lg font-semibold text-gray-900">Números de parte con BOM</h3>
      <div class="flex items-center gap-2">
        <input type="text" id="partes-search" placeholder="Buscar parte o descripción..." class="w-56 rounded-md border border-gray-300 px-2 py-1 text-sm" />
        <label class="text-sm text-gray-600">
          Límite:
          <input type="number" id="partes-limit" min="1" max="200" value="50" class="ml-1 w-20 rounded-md border border-gray-300 px-2 py-1 text-sm" />
        </label>
        <button type="button" id="btn-recargar-partes" class="rounded-md border border-gray-300 bg-white px-3 py-1.5 text-sm font-medium text-gray-700 hover:bg-gray-50">
          Recargar
        </button>
      </div>
    </div>
    <p id="partes-msg" class="mt-2 text-xs text-gray-500">Cargando partes...</p>
    <div class="mt-3 max-h-80 overflow-y-auto rounded border border-gray-200">
      <table class="min-w-full text-sm">
        <thead class="bg-gray-50">
          <tr class="border-b text-left text-gray-500">
            <th class="py-2 px-3">Nº parte</th>
            <th class="py-2 px-3">Descripción</th>
            <th class="py-2 px-3">Válido</th>
            <th class="py-2 px-3">
              <button type="button" id="sort-total-boms" class="inline-flex items-center gap-1 font-medium text-gray-600 hover:text-[#003D89]">
                BOMs
                <span id="sort-total-boms-ind" class="text-xs text-gray-400">↕</span>
              </button>
            </th>
            <th class="py-2 px-3">
              <button type="button" id="sort-total-revisiones" class="inline-flex items-center gap-1 font-medium text-gray-600 hover:text-[#003D89]">
                Revisiones
                <span id="sort-total-revisiones-ind" class="text-xs text-gray-400">↕</span>
              </button>
            </th>
            <th class="py-2 px-3">Acción</th>
          </tr>
        </thead>
        <tbody id="partes-body"></tbody>
      </table>
    </div>
    <div class="mt-3 flex items-center justify-between gap-3">
      <p id="partes-paginacion-texto" class="text-xs text-gray-500">Página 1 de 1</p>
      <div class="flex items-center gap-2">
        <button type="button" id="btn-partes-anterior" class="rounded-md border border-gray-300 bg-white px-3 py-1.5 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50">
          Anterior
        </button>
        <button type="button" id="btn-partes-siguiente" class="rounded-md border border-gray-300 bg-white px-3 py-1.5 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50">
          Siguiente
        </button>
      </div>
    </div>
  </div>

  <!-- Ayuda -->
  <div class="rounded-lg bg-white p-6 shadow-sm">
    <h3 class="text-sm font-semibold text-gray-900">Requisitos</h3>
    <ul class="mt-2 list-inside list-disc text-sm text-gray-600">
      <li><strong>La aplicación (uvicorn) debe estar corriendo en la misma PC y la misma sesión de Windows donde tienes SAP GUI abierto.</strong> Si el servidor corre en otro equipo, el script no podrá conectar con SAP.</li>
      <li>SAP GUI instalado, con una sesión abierta (el script usa la primera ventana disponible).</li>
      <li>Carpeta de exportación configurada (<code class="rounded bg-gray-100 px-1">BOM_EXPORT_DIR</code> o la ruta por defecto). Debe existir en disco.</li>
      <li>Opcional: <code class="rounded bg-gray-100 px-1">BOM_VBS_PATH</code> (ruta a bom.vbs) y <code class="rounded bg-gray-100 px-1">BOM_VBS_TIMEOUT_SEC</code> (segundos por parte).</li>
    </ul>
    <p class="mt-2 text-sm text-amber-700">Si al pulsar Actualizar no pasa nada en SAP, revisa el detalle por parte al finalizar: ahí aparecerá el error del script (p. ej. &quot;ActiveX component can't create object&quot; si SAP no está accesible).</p>
  </div>
</div>

<!-- Modal detalle BOM -->
<div id="modal-parte-detalle" class="relative z-50 hidden" role="dialog" aria-modal="true">
  <div class="fixed inset-0 bg-gray-900/70" id="modal-parte-backdrop"></div>
  <div class="fixed inset-0 z-10 overflow-y-auto">
    <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
      <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 w-11/12 max-w-6xl max-h-[90vh] flex flex-col">
        <div class="flex items-start justify-between border-b border-gray-200 px-5 py-4">
          <div>
            <h3 class="text-base font-semibold text-gray-900">Detalle BOM e historial</h3>
            <p class="mt-1 text-sm text-gray-600">
              Parte: <span id="modal-parte-no" class="font-medium text-gray-900"></span> -
              <span id="modal-parte-desc" class="text-gray-700"></span>
            </p>
          </div>
          <button type="button" id="modal-parte-cerrar" class="rounded-md bg-white text-gray-400 hover:text-gray-600">
            <span class="sr-only">Cerrar</span>
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <div class="p-5 overflow-y-auto space-y-5">
          <div>
            <h4 class="text-sm font-semibold text-gray-900 mb-2">Elementos del BOM vigente</h4>
            <div class="max-h-72 overflow-y-auto rounded border border-gray-200">
              <table class="min-w-full text-xs">
                <thead class="bg-gray-50">
                  <tr class="border-b text-left text-gray-500">
                    <th class="py-2 px-2">Plant</th>
                    <th class="py-2 px-2">Usage</th>
                    <th class="py-2 px-2">Alt</th>
                    <th class="py-2 px-2">Rev</th>
                    <th class="py-2 px-2">Item</th>
                    <th class="py-2 px-2">Componente</th>
                    <th class="py-2 px-2">Qty</th>
                    <th class="py-2 px-2">UOM</th>
                    <th class="py-2 px-2">Comm. code</th>
                    <th class="py-2 px-2">Origen</th>
                  </tr>
                </thead>
                <tbody id="modal-elementos-body"></tbody>
              </table>
            </div>
          </div>

          <div>
            <h4 class="text-sm font-semibold text-gray-900 mb-2">Historial de cambios</h4>
            <div class="max-h-72 overflow-y-auto rounded border border-gray-200">
              <table class="min-w-full text-xs">
                <thead class="bg-gray-50">
                  <tr class="border-b text-left text-gray-500">
                    <th class="py-2 px-2">Plant</th>
                    <th class="py-2 px-2">Usage</th>
                    <th class="py-2 px-2">Alt</th>
                    <th class="py-2 px-2">Rev</th>
                    <th class="py-2 px-2">Desde</th>
                    <th class="py-2 px-2">Hasta</th>
                    <th class="py-2 px-2">Vigente</th>
                    <th class="py-2 px-2">Fuente</th>
                    <th class="py-2 px-2">Creado</th>
                  </tr>
                </thead>
                <tbody id="modal-historial-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  const btn = document.getElementById('btn-actualizar-boms');
  const btnParar = document.getElementById('btn-parar-boms');
  const estado = document.getElementById('bom-estado');
  const estadoTexto = document.getElementById('bom-estado-texto');
  const resultado = document.getElementById('bom-resultado');
  const limitInput = document.getElementById('bom-limit');
  const progresoDiv = document.getElementById('bom-progreso');
  const logDiv = document.getElementById('bom-log');
  const progN = document.getElementById('bom-progreso-n');
  const progTotal = document.getElementById('bom-progreso-total');
  const progCon = document.getElementById('bom-progreso-con');
  const progSin = document.getElementById('bom-progreso-sin');
  const progErr = document.getElementById('bom-progreso-err');
  const partesSearchInput = document.getElementById('partes-search');
  const partesLimitInput = document.getElementById('partes-limit');
  const btnRecargarPartes = document.getElementById('btn-recargar-partes');
  const partesMsg = document.getElementById('partes-msg');
  const partesBody = document.getElementById('partes-body');
  const partesPaginacionTexto = document.getElementById('partes-paginacion-texto');
  const btnPartesAnterior = document.getElementById('btn-partes-anterior');
  const btnPartesSiguiente = document.getElementById('btn-partes-siguiente');
  const sortTotalBomsBtn = document.getElementById('sort-total-boms');
  const sortTotalRevisionesBtn = document.getElementById('sort-total-revisiones');
  const sortTotalBomsInd = document.getElementById('sort-total-boms-ind');
  const sortTotalRevisionesInd = document.getElementById('sort-total-revisiones-ind');
  const modalParte = document.getElementById('modal-parte-detalle');
  const modalParteBackdrop = document.getElementById('modal-parte-backdrop');
  const modalParteCerrarBtn = document.getElementById('modal-parte-cerrar');
  let abortController = null;
  let partesRows = [];
  let partesCurrentPage = 1;
  let partesSort = { key: null, direction: 'desc' };

  function updatePaginationControls(total, limit) {
    const totalPages = Math.max(1, Math.ceil((Number(total) || 0) / (Number(limit) || 1)));
    if (partesPaginacionTexto) {
      partesPaginacionTexto.textContent = 'Página ' + partesCurrentPage + ' de ' + totalPages;
    }
    if (btnPartesAnterior) btnPartesAnterior.disabled = partesCurrentPage <= 1;
    if (btnPartesSiguiente) btnPartesSiguiente.disabled = partesCurrentPage >= totalPages;
  }

  function addLog(line, clase) {
    const p = document.createElement('p');
    p.className = clase || 'text-gray-700';
    p.textContent = line;
    logDiv.appendChild(p);
    logDiv.scrollTop = logDiv.scrollHeight;
  }

  function esc(value) {
    if (value === null || value === undefined) return '';
    return String(value)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function abrirModalParte() {
    modalParte.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }

  function cerrarModalParte() {
    modalParte.classList.add('hidden');
    document.body.style.overflow = '';
  }

  function getSortedPartesRows(rows) {
    if (!partesSort.key) return rows.slice();
    const factor = partesSort.direction === 'asc' ? 1 : -1;
    return rows.slice().sort(function(a, b) {
      const av = Number(a[partesSort.key] || 0);
      const bv = Number(b[partesSort.key] || 0);
      if (av === bv) return String(a.numero_parte || '').localeCompare(String(b.numero_parte || ''));
      return (av - bv) * factor;
    });
  }

  function updateSortIndicators() {
    if (sortTotalBomsInd) {
      sortTotalBomsInd.textContent = partesSort.key === 'total_boms' ? (partesSort.direction === 'asc' ? '↑' : '↓') : '↕';
      sortTotalBomsInd.className = partesSort.key === 'total_boms' ? 'text-xs text-[#003D89]' : 'text-xs text-gray-400';
    }
    if (sortTotalRevisionesInd) {
      sortTotalRevisionesInd.textContent = partesSort.key === 'total_revisiones' ? (partesSort.direction === 'asc' ? '↑' : '↓') : '↕';
      sortTotalRevisionesInd.className = partesSort.key === 'total_revisiones' ? 'text-xs text-[#003D89]' : 'text-xs text-gray-400';
    }
  }

  function renderPartesRows(rows) {
    const rowsToRender = getSortedPartesRows(rows);
    partesBody.innerHTML = '';
    if (!rowsToRender || rowsToRender.length === 0) {
      partesBody.innerHTML = '<tr><td colspan="6" class="py-3 px-3 text-gray-400">Sin resultados</td></tr>';
      updateSortIndicators();
      return;
    }

    partesBody.innerHTML = rowsToRender.map(function(row) {
      var badge = row.valido
        ? '<span class="inline-flex items-center rounded-full bg-green-50 px-2 py-0.5 text-xs font-medium text-green-700">Sí</span>'
        : '<span class="inline-flex items-center rounded-full bg-red-50 px-2 py-0.5 text-xs font-medium text-red-700">No</span>';
      return '<tr class="border-b border-gray-100">' +
        '<td class="py-2 px-3 font-mono text-gray-900">' + esc(row.numero_parte) + '</td>' +
        '<td class="py-2 px-3 text-gray-700">' + esc(row.descripcion || '') + '</td>' +
        '<td class="py-2 px-3">' + badge + '</td>' +
        '<td class="py-2 px-3 text-gray-700">' + esc(row.total_boms) + '</td>' +
        '<td class="py-2 px-3 text-gray-700">' + esc(row.total_revisiones) + '</td>' +
        '<td class="py-2 px-3"><button type="button" class="btn-ver-detalle rounded-md bg-[#003D89] px-3 py-1 text-xs font-semibold text-white hover:bg-[#003366]" data-parte-no="' + esc(row.numero_parte) + '">Ver detalle</button></td>' +
      '</tr>';
    }).join('');

    partesBody.querySelectorAll('.btn-ver-detalle').forEach(function(btnDetalle) {
      btnDetalle.addEventListener('click', function() {
        const parteNo = this.getAttribute('data-parte-no');
        verDetalleParte(parteNo);
      });
    });

    updateSortIndicators();
  }

  function togglePartesSort(key) {
    if (partesSort.key === key) {
      partesSort.direction = partesSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
      partesSort.key = key;
      partesSort.direction = 'desc';
    }
    renderPartesRows(partesRows);
  }

  async function cargarResumenPartes(resetPage) {
    if (resetPage) partesCurrentPage = 1;
    const q = partesSearchInput && partesSearchInput.value ? partesSearchInput.value.trim() : '';
    const limit = partesLimitInput && partesLimitInput.value ? parseInt(partesLimitInput.value, 10) : 50;
    const safeLimit = Number.isFinite(limit) && limit > 0 ? Math.min(limit, 200) : 50;
    const offset = (partesCurrentPage - 1) * safeLimit;
    partesMsg.textContent = 'Cargando partes...';
    try {
      const params = new URLSearchParams({ limit: String(safeLimit), offset: String(offset) });
      if (q) params.set('q', q);
      const res = await fetch('/api/actualizar-boms/partes?' + params.toString(), { credentials: 'same-origin' });
      const data = await res.json();
      if (!res.ok || !data.ok) throw new Error(data.mensaje || 'Error al consultar partes');

      const total = Number(data.total || 0);
      const totalPages = Math.max(1, Math.ceil(total / safeLimit));
      if (partesCurrentPage > totalPages) {
        partesCurrentPage = totalPages;
        return cargarResumenPartes(false);
      }
      partesRows = Array.isArray(data.rows) ? data.rows : [];
      renderPartesRows(partesRows);
      updatePaginationControls(total, safeLimit);

      const shown = Array.isArray(data.rows) ? data.rows.length : 0;
      const desde = total === 0 ? 0 : offset + 1;
      const hasta = offset + shown;
      partesMsg.textContent = 'Mostrando ' + desde + '-' + hasta + ' de ' + total + ' partes con BOM.';
    } catch (e) {
      partesMsg.textContent = 'Error al cargar partes: ' + (e.message || e);
      updatePaginationControls(0, safeLimit);
    }
  }

  async function verDetalleParte(parteNo) {
    try {
      const res = await fetch('/api/actualizar-boms/parte-detalle?parte_no=' + encodeURIComponent(parteNo), { credentials: 'same-origin' });
      const data = await res.json();
      if (!res.ok || !data.ok) throw new Error(data.mensaje || 'No se pudo cargar el detalle');

      document.getElementById('modal-parte-no').textContent = data.parte.numero_parte || '';
      document.getElementById('modal-parte-desc').textContent = data.parte.descripcion || 'Sin descripción';

      const tbodyElementos = document.getElementById('modal-elementos-body');
      tbodyElementos.innerHTML = '';
      if (!data.elementos_bom || data.elementos_bom.length === 0) {
        tbodyElementos.innerHTML = '<tr><td colspan="10" class="py-2 px-2 text-gray-400">Sin BOM vigente para esta parte.</td></tr>';
      } else {
        tbodyElementos.innerHTML = data.elementos_bom.map(function(it) {
          return '<tr class="border-b border-gray-100">' +
            '<td class="py-1 px-2">' + esc(it.plant) + '</td>' +
            '<td class="py-1 px-2">' + esc(it.usage) + '</td>' +
            '<td class="py-1 px-2">' + esc(it.alternative) + '</td>' +
            '<td class="py-1 px-2">' + esc(it.revision_no) + '</td>' +
            '<td class="py-1 px-2">' + esc(it.item_no || '') + '</td>' +
            '<td class="py-1 px-2 font-mono">' + esc(it.componente_no || '') + '</td>' +
            '<td class="py-1 px-2">' + esc(it.qty) + '</td>' +
            '<td class="py-1 px-2">' + esc(it.measure || '') + '</td>' +
            '<td class="py-1 px-2">' + esc(it.comm_code || '') + '</td>' +
            '<td class="py-1 px-2">' + esc(it.origin || '') + '</td>' +
          '</tr>';
        }).join('');
      }

      const tbodyHistorial = document.getElementById('modal-historial-body');
      tbodyHistorial.innerHTML = '';
      if (!data.historial || data.historial.length === 0) {
        tbodyHistorial.innerHTML = '<tr><td colspan="9" class="py-2 px-2 text-gray-400">Sin historial de cambios.</td></tr>';
      } else {
        tbodyHistorial.innerHTML = data.historial.map(function(h) {
          return '<tr class="border-b border-gray-100">' +
            '<td class="py-1 px-2">' + esc(h.plant) + '</td>' +
            '<td class="py-1 px-2">' + esc(h.usage) + '</td>' +
            '<td class="py-1 px-2">' + esc(h.alternative) + '</td>' +
            '<td class="py-1 px-2">' + esc(h.revision_no) + '</td>' +
            '<td class="py-1 px-2">' + esc(h.effective_from || '') + '</td>' +
            '<td class="py-1 px-2">' + esc(h.effective_to || '') + '</td>' +
            '<td class="py-1 px-2">' + (h.vigente ? 'Sí' : 'No') + '</td>' +
            '<td class="py-1 px-2">' + esc(h.source || '') + '</td>' +
            '<td class="py-1 px-2">' + esc(h.created_at || '') + '</td>' +
          '</tr>';
        }).join('');
      }

      abrirModalParte();
    } catch (e) {
      addLog('No se pudo abrir detalle de ' + parteNo + ': ' + (e.message || e), 'text-red-700');
    }
  }

  btn.addEventListener('click', async function() {
    abortController = new AbortController();
    btn.disabled = true;
    btnParar.classList.remove('hidden');
    estado.classList.remove('hidden');
    resultado.classList.add('hidden');
    progresoDiv.classList.add('hidden');
    logDiv.innerHTML = '';
    estadoTexto.textContent = 'Ejecutando actualización (verás cada registro en tiempo real)...';
    estado.classList.add('bg-blue-50');
    estado.classList.remove('bg-red-50');

    const limit = limitInput.value.trim() ? parseInt(limitInput.value, 10) : null;
    const params = new URLSearchParams();
    if (limit != null && limit > 0) params.set('limit', String(limit));
    const url = '/api/actualizar-boms/ejecutar-actualizacion-stream' + (params.toString() ? ('?' + params.toString()) : '');

    let con = 0, sin = 0, err = 0, n = 0, total = 0;

    function finProceso() {
      btn.disabled = false;
      btnParar.classList.add('hidden');
      abortController = null;
    }

    try {
      const res = await fetch(url, { method: 'POST', credentials: 'same-origin', signal: abortController.signal });
      if (!res.ok) {
        const data = await res.json().catch(function() { return {}; });
        estadoTexto.textContent = data.mensaje || 'Error al ejecutar la actualización.';
        estado.classList.add('bg-red-50');
        estado.classList.remove('bg-blue-50');
        finProceso();
        return;
      }
      progresoDiv.classList.remove('hidden');
      progTotal.textContent = '?';

      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';
      while (true) {
        var chunk = await reader.read();
        if (chunk.done) break;
        buffer += decoder.decode(chunk.value, { stream: true });
        var lines = buffer.split('\n');
        buffer = lines.pop() || '';
        for (var i = 0; i < lines.length; i++) {
          var line = lines[i].trim();
          if (!line) continue;
          try {
            var data = JSON.parse(line);
            if (data.tipo === 'error') {
              estadoTexto.textContent = data.mensaje || 'Error';
              estado.classList.add('bg-red-50');
              break;
            }
            if (data.tipo === 'inicio') {
              total = data.total || 0;
              progTotal.textContent = total;
              addLog('Total a procesar: ' + total, 'text-gray-600');
              continue;
            }
            if (data.tipo === 'reset') {
              addLog(data.mensaje || 'Reproceso desde cero aplicado.', 'text-amber-700');
              continue;
            }
            if (data.tipo === 'parte_inicio') {
              estadoTexto.textContent = 'Procesando parte: ' + (data.parte_no || '');
              addLog((data.parte_no || '') + ' — Ejecutando SAP...', 'text-blue-700');
              continue;
            }
            if (data.tipo === 'parte') {
              n++;
              progN.textContent = n;
              if (data.estado === 'actualizado') {
                con++;
                progCon.textContent = con;
                addLog(data.parte_no + ' — Insertado en BD (' + (data.items_insertados != null ? data.items_insertados + ' items' : '') + ')', 'text-green-700');
              } else if (data.estado === 'sin_cambios') {
                sin++;
                progSin.textContent = sin;
                addLog(data.parte_no + ' — Ya existía (omitido)', 'text-gray-600');
              } else {
                err++;
                progErr.textContent = err;
                addLog(data.parte_no + ' — Error: ' + (data.mensaje || ''), 'text-red-700');
              }
              continue;
            }
            if (data.tipo === 'fin') {
              finProceso();
              estado.classList.add('hidden');
              resultado.classList.remove('hidden');
              document.getElementById('res-total').textContent = data.total ?? 0;
              document.getElementById('res-procesados').textContent = data.procesados ?? 0;
              document.getElementById('res-con-cambios').textContent = data.con_cambios ?? 0;
              document.getElementById('res-sin-cambios').textContent = data.sin_cambios ?? 0;
              document.getElementById('res-errores').textContent = data.errores ?? 0;
              document.getElementById('res-mensaje').textContent = 'Procesados ' + data.procesados + '/' + data.total + '; con cambios: ' + data.con_cambios + ', sin cambios: ' + data.sin_cambios + ', errores: ' + data.errores;
              var tbody = document.getElementById('res-detalle');
              tbody.innerHTML = '';
              (data.detalle || []).forEach(function(row) {
                var tr = document.createElement('tr');
                tr.className = 'border-b border-gray-100';
                tr.innerHTML = '<td class="py-1 pr-4 font-mono text-gray-800">' + (row.parte_no || '') + '</td><td class="py-1 pr-4">' + (row.estado || '') + '</td><td class="py-1 text-gray-600">' + (row.mensaje || '') + '</td>';
                tbody.appendChild(tr);
              });
              await cargarResumenPartes(false);
              break;
            }
          } catch (parseErr) {
            addLog('Linea no JSON: ' + line.substring(0, 80), 'text-amber-700');
          }
        }
      }
    } catch (e) {
      if (e.name === 'AbortError') {
        estadoTexto.textContent = 'Proceso detenido por el usuario.';
        if (logDiv && logDiv.innerHTML) addLog('— Detenido.', 'text-amber-700');
      } else {
        estadoTexto.textContent = 'Error de conexión: ' + e.message;
      }
      estado.classList.add('bg-red-50');
      estado.classList.remove('bg-blue-50');
      finProceso();
    }
  });

  btnParar.addEventListener('click', function() {
    if (abortController) abortController.abort();
  });

  btnRecargarPartes.addEventListener('click', function() {
    cargarResumenPartes(true);
  });
  partesSearchInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') cargarResumenPartes(true);
  });
  partesLimitInput.addEventListener('change', function() {
    cargarResumenPartes(true);
  });
  if (btnPartesAnterior) {
    btnPartesAnterior.addEventListener('click', function() {
      if (partesCurrentPage <= 1) return;
      partesCurrentPage -= 1;
      cargarResumenPartes(false);
    });
  }
  if (btnPartesSiguiente) {
    btnPartesSiguiente.addEventListener('click', function() {
      partesCurrentPage += 1;
      cargarResumenPartes(false);
    });
  }
  if (sortTotalBomsBtn) {
    sortTotalBomsBtn.addEventListener('click', function() {
      togglePartesSort('total_boms');
    });
  }
  if (sortTotalRevisionesBtn) {
    sortTotalRevisionesBtn.addEventListener('click', function() {
      togglePartesSort('total_revisiones');
    });
  }

  modalParteCerrarBtn.addEventListener('click', cerrarModalParte);
  modalParteBackdrop.addEventListener('click', cerrarModalParte);
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') cerrarModalParte();
  });

  cargarResumenPartes(true);
})();
</script>
{% endblock %}
