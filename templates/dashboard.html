{% extends "base.html" %} {% block content %}
<div class="space-y-6">
  <!-- Header -->
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-semibold text-gray-900">Dashboard</h1>
      <p class="mt-1 text-sm text-gray-600">
        Bienvenido, {{ current_user.nombre or current_user.email }}
      </p>
    </div>
    <div class="flex items-center gap-4">
      <span class="inline-flex items-center rounded-full bg-blue-100 px-3 py-1 text-sm font-medium text-blue-800">
        {{ current_user.rol|upper }}
      </span>
      <a
        href="/auth/logout"
        class="rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
      >
        Cerrar sesión
      </a>
    </div>
  </div>

  <!-- Estadísticas -->
  {% if stats %}
  <div class="rounded-lg bg-white p-6 shadow-sm">
    <h2 class="mb-4 text-lg font-medium text-gray-900">Resumen del sistema</h2>
    <dl class="grid grid-cols-2 gap-4 sm:grid-cols-4 lg:grid-cols-7">
      <div class="overflow-hidden rounded-lg bg-gray-50 px-4 py-5 sm:p-6">
        <dt class="truncate text-sm font-medium text-gray-500">Ventas</dt>
        <dd class="mt-1 text-2xl font-semibold tracking-tight text-gray-900">{{ "{:,}".format(stats.total_ventas) }}</dd>
        <a href="/ventas-registros" class="mt-2 inline-block text-xs text-[#003D89] hover:underline">Ver registros</a>
      </div>
      <div class="overflow-hidden rounded-lg bg-gray-50 px-4 py-5 sm:p-6">
        <dt class="truncate text-sm font-medium text-gray-500">Compras</dt>
        <dd class="mt-1 text-2xl font-semibold tracking-tight text-gray-900">{{ "{:,}".format(stats.total_compras) }}</dd>
        <a href="/todas-compras" class="mt-2 inline-block text-xs text-[#003D89] hover:underline">Ver registros</a>
      </div>
      <div class="overflow-hidden rounded-lg bg-gray-50 px-4 py-5 sm:p-6">
        <dt class="truncate text-sm font-medium text-gray-500">Virtuales (mes)</dt>
        <dd class="mt-1 text-2xl font-semibold tracking-tight text-[#003D89]">{{ "{:,}".format(stats.total_virtuales) }}</dd>
        <a href="/virtuales" class="mt-2 inline-block text-xs text-[#003D89] hover:underline">Ver virtuales</a>
      </div>
      <div class="overflow-hidden rounded-lg bg-gray-50 px-4 py-5 sm:p-6">
        <dt class="truncate text-sm font-medium text-gray-500">Clientes</dt>
        <dd class="mt-1 text-2xl font-semibold tracking-tight text-gray-900">{{ "{:,}".format(stats.total_clientes) }}</dd>
        <a href="/clientes" class="mt-2 inline-block text-xs text-[#003D89] hover:underline">Ver clientes</a>
      </div>
      <div class="overflow-hidden rounded-lg bg-gray-50 px-4 py-5 sm:p-6">
        <dt class="truncate text-sm font-medium text-gray-500">Proveedores</dt>
        <dd class="mt-1 text-2xl font-semibold tracking-tight text-gray-900">{{ "{:,}".format(stats.total_proveedores) }}</dd>
        <a href="/proveedores" class="mt-2 inline-block text-xs text-[#003D89] hover:underline">Ver proveedores</a>
      </div>
      <div class="overflow-hidden rounded-lg bg-gray-50 px-4 py-5 sm:p-6">
        <dt class="truncate text-sm font-medium text-gray-500">Materiales</dt>
        <dd class="mt-1 text-2xl font-semibold tracking-tight text-gray-900">{{ "{:,}".format(stats.total_materiales) }}</dd>
        <a href="/materiales" class="mt-2 inline-block text-xs text-[#003D89] hover:underline">Ver materiales</a>
      </div>
      <div class="overflow-hidden rounded-lg bg-gray-50 px-4 py-5 sm:p-6">
        <dt class="truncate text-sm font-medium text-gray-500">Precios compra</dt>
        <dd class="mt-1 text-2xl font-semibold tracking-tight text-gray-900">{{ "{:,}".format(stats.total_precios_compra) }}</dd>
        <a href="/precios-compra" class="mt-2 inline-block text-xs text-[#003D89] hover:underline">Ver precios</a>
      </div>
    </dl>
  </div>
  {% endif %}

  <!-- Virtuales - Botones de actualización -->
  <div class="rounded-lg bg-white p-6 shadow-sm">
    <h2 class="mb-4 text-lg font-medium text-gray-900">Virtuales</h2>
    <p class="mb-4 text-sm text-gray-500">Actualiza el master de virtuales, carga de proveedores y carga de clientes.</p>
    <div class="flex flex-wrap items-center gap-x-0 gap-y-3">
      <button
        type="button"
        data-endpoint="/api/virtuales/actualizar"
        data-label="Actualizar Master Virtuales"
        class="btn-actualizar-dashboard inline-flex items-center rounded-md bg-[#003D89] px-4 py-2 text-sm font-medium text-white hover:bg-[#002d66] disabled:opacity-50"
      >
        <span class="btn-text">Actualizar Master Virtuales</span>
        <svg class="btn-spinner ml-2 hidden h-4 w-4 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
      </button>
      <div class="hidden sm:block w-px h-8 bg-gray-200 mx-1" aria-hidden="true"></div>
      <button type="button" data-endpoint="/carga-proveedor/actualizar" data-label="Carga Proveedor" class="btn-actualizar-dashboard inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50">
        <span class="btn-text">Carga Proveedor</span>
        <svg class="btn-spinner ml-2 hidden h-4 w-4 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
      </button>
      <div class="hidden sm:block w-px h-8 bg-gray-200 mx-1" aria-hidden="true"></div>
      <button type="button" data-endpoint="/carga-proveedores-nacional/actualizar" data-label="Carga Proveedores Nacional" class="btn-actualizar-dashboard inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50">
        <span class="btn-text">Carga Proveedores Nacional</span>
        <svg class="btn-spinner ml-2 hidden h-4 w-4 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
      </button>
      <div class="hidden sm:block w-px h-8 bg-gray-200 mx-1" aria-hidden="true"></div>
      <button type="button" data-endpoint="/carga-cliente/actualizar" data-label="Carga Cliente" class="btn-actualizar-dashboard inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50">
        <span class="btn-text">Carga Cliente</span>
        <svg class="btn-spinner ml-2 hidden h-4 w-4 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
      </button>
    </div>
    <a href="/virtuales" class="mt-4 inline-block text-sm text-[#003D89] hover:underline">Ver página de Virtuales</a>
    <div id="toast-dashboard" class="fixed bottom-4 right-4 z-50 hidden rounded-lg px-4 py-3 shadow-lg" role="alert"></div>
  </div>

  <!-- Descargas Excel -->
  <div class="rounded-lg bg-white p-6 shadow-sm">
    <h2 class="mb-4 text-lg font-medium text-gray-900">Descargas Excel</h2>
    <p class="mb-4 text-sm text-gray-500">Descarga reportes en formato Excel para Carga Proveedores/Clientes, Carga Proveedores Nacionales y Virtuales.</p>

    <div class="space-y-6">
      <div class="md:flex md:items-center md:justify-between">
        <div class="min-w-0 flex-1">
          <h3 class="text-base font-semibold text-gray-900 sm:truncate">Descargar Excel Carga Proveedores/Clientes</h3>
        </div>
        <div class="mt-4 flex md:mt-0 md:ml-4">
          <a
            href="/carga-proveedor-cliente/descargar-excel"
            class="inline-flex items-center rounded-md bg-green-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-700 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-green-600"
          >
            <svg class="mr-1.5 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
            </svg>
            Descargar
          </a>
        </div>
      </div>

      <div class="md:flex md:items-center md:justify-between">
        <div class="min-w-0 flex-1">
          <h3 class="text-base font-semibold text-gray-900 sm:truncate">Descargar Excel Carga Proveedores Nacionales</h3>
        </div>
        <div class="mt-4 flex md:mt-0 md:ml-4">
          <a
            href="/carga-proveedores-nacional/descargar-excel"
            class="inline-flex items-center rounded-md bg-green-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-700 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-green-600"
          >
            <svg class="mr-1.5 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
            </svg>
            Descargar
          </a>
        </div>
      </div>

      <div class="md:flex md:items-center md:justify-between">
        <div class="min-w-0 flex-1">
          <h3 class="text-base font-semibold text-gray-900 sm:truncate">Descargar Excel Virtuales</h3>
        </div>
        <div class="mt-4 flex flex-wrap items-center gap-2 md:mt-0 md:ml-4">
          <select
            id="excel-mes-dashboard"
            class="rounded-md border border-gray-300 bg-white px-2 py-1.5 text-sm text-gray-900 shadow-sm focus:border-[#003D89] focus:outline-none focus:ring-1 focus:ring-[#003D89]"
            title="Mes"
          >
            <option value="">Mes</option>
            <option value="Enero">Enero</option>
            <option value="Febrero">Febrero</option>
            <option value="Marzo">Marzo</option>
            <option value="Abril">Abril</option>
            <option value="Mayo">Mayo</option>
            <option value="Junio">Junio</option>
            <option value="Julio">Julio</option>
            <option value="Agosto">Agosto</option>
            <option value="Septiembre">Septiembre</option>
            <option value="Octubre">Octubre</option>
            <option value="Noviembre">Noviembre</option>
            <option value="Diciembre">Diciembre</option>
          </select>
          <select
            id="excel-año-dashboard"
            class="rounded-md border border-gray-300 bg-white px-2 py-1.5 text-sm text-gray-900 shadow-sm focus:border-[#003D89] focus:outline-none focus:ring-1 focus:ring-[#003D89]"
            title="Año"
          >
            {% for a in años_disponibles %}
            <option value="{{ a }}" {% if a == años_disponibles[0] %}selected{% endif %}>{{ a }}</option>
            {% endfor %}
          </select>
          <button
            id="btn-descargar-excel-virtuales-dashboard"
            type="button"
            class="inline-flex items-center rounded-md bg-[#003D89] px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-[#002d66] focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[#003D89]"
          >
            <svg class="mr-1.5 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
            </svg>
            Descargar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal: mes ya actualizado -->
<div id="modal-ya-actualizado-dashboard" class="hidden fixed inset-0 z-[60] overflow-y-auto" aria-labelledby="modal-ya-actualizado-dashboard-title" role="dialog" aria-modal="true">
  <div class="flex min-h-screen items-end justify-center px-4 pt-4 pb-20 text-center sm:block sm:p-0">
    <div id="modal-ya-actualizado-dashboard-backdrop" class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
    <span class="hidden sm:inline-block sm:h-screen sm:align-middle" aria-hidden="true">&#8203;</span>
    <div class="relative inline-block transform overflow-hidden rounded-lg bg-white text-left align-bottom shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-md sm:align-middle">
      <div class="bg-amber-500 px-6 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <svg class="h-6 w-6 text-white flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
            </svg>
            <h3 class="text-lg font-semibold text-white" id="modal-ya-actualizado-dashboard-title">Mes ya actualizado</h3>
          </div>
          <button id="btn-cerrar-modal-ya-actualizado-dashboard-x" type="button" class="text-white hover:text-gray-200 focus:outline-none">
            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </div>
      <div class="px-6 py-4">
        <p id="modal-ya-actualizado-dashboard-mensaje" class="text-sm text-gray-700">Ese mes ya se actualizaron los registros.</p>
      </div>
      <div class="bg-gray-50 px-6 py-3 flex justify-end">
        <button id="btn-cerrar-modal-ya-actualizado-dashboard" type="button" class="rounded-md bg-amber-500 px-4 py-2 text-sm font-medium text-white hover:bg-amber-600 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2">Entendido</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const toast = document.getElementById('toast-dashboard');
  function showToast(msg, isError) {
    if (!toast) return;
    toast.textContent = msg;
    toast.className = 'fixed bottom-4 right-4 z-50 rounded-lg px-4 py-3 shadow-lg ' + (isError ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800');
    toast.classList.remove('hidden');
    setTimeout(() => toast.classList.add('hidden'), 6000);
  }

  function mostrarModalYaActualizado(mensaje) {
    const modal = document.getElementById('modal-ya-actualizado-dashboard');
    const texto = document.getElementById('modal-ya-actualizado-dashboard-mensaje');
    if (modal && texto) {
      texto.textContent = mensaje || 'Ese mes ya se actualizaron los registros.';
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
  }
  function cerrarModalYaActualizado() {
    const modal = document.getElementById('modal-ya-actualizado-dashboard');
    if (modal) {
      modal.classList.add('hidden');
      document.body.style.overflow = '';
    }
  }
  document.getElementById('btn-cerrar-modal-ya-actualizado-dashboard')?.addEventListener('click', cerrarModalYaActualizado);
  document.getElementById('btn-cerrar-modal-ya-actualizado-dashboard-x')?.addEventListener('click', cerrarModalYaActualizado);
  document.getElementById('modal-ya-actualizado-dashboard-backdrop')?.addEventListener('click', cerrarModalYaActualizado);
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      const m = document.getElementById('modal-ya-actualizado-dashboard');
      if (m && !m.classList.contains('hidden')) cerrarModalYaActualizado();
    }
  });

  const btnDescargarExcelVirtuales = document.getElementById('btn-descargar-excel-virtuales-dashboard');
  if (btnDescargarExcelVirtuales) {
    btnDescargarExcelVirtuales.addEventListener('click', function() {
      const mes = (document.getElementById('excel-mes-dashboard')?.value || '').trim();
      const año = (document.getElementById('excel-año-dashboard')?.value || '').trim();
      if (!mes) {
        showToast('Seleccione un mes para descargar el Excel de Virtuales.', true);
        return;
      }
      const url = '/virtuales/descargar-excel?mes=' + encodeURIComponent(mes) + (año ? '&anio=' + encodeURIComponent(año) : '');
      window.location.href = url;
    });
  }

  document.querySelectorAll('.btn-actualizar-dashboard').forEach(function(btn) {
    const btnText = btn.querySelector('.btn-text');
    const originalText = btnText ? btnText.textContent : 'Actualizar';

    btn.addEventListener('click', async function() {
      const endpoint = this.dataset.endpoint;
      const btnSpinner = this.querySelector('.btn-spinner');

      if (!endpoint) return;
      this.disabled = true;
      if (btnText) btnText.textContent = 'Actualizando...';
      if (btnSpinner) btnSpinner.classList.remove('hidden');

      try {
        const response = await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' } });
        const data = await response.json().catch(() => ({}));

        let msg = '';
        if (response.ok) {
          if (data.ya_actualizado) {
            mostrarModalYaActualizado(data.message || 'Ese mes ya se actualizaron los registros.');
          } else {
            msg = data.message || data.mensaje || data.error || 'Actualización completada.';
            if (data.resumen && typeof data.resumen === 'object') {
              const r = data.resumen;
              const partes = [];
              if (r.altas != null) partes.push(r.altas + ' altas');
              if (r.bajas != null) partes.push(r.bajas + ' bajas');
              if (r.nuevos != null) partes.push(r.nuevos + ' nuevos');
              if (r.actualizados != null) partes.push(r.actualizados + ' actualizados');
              if (partes.length) msg += ' (' + partes.join(', ') + ')';
            }
            showToast(msg, false);
            if (endpoint === '/api/virtuales/actualizar') window.location.reload();
          }
        } else {
          msg = data.error || data.message || data.mensaje || 'Error en la actualización';
          showToast(msg, true);
        }
      } catch (err) {
        showToast('Error de conexión: ' + (err.message || 'Desconocido'), true);
      } finally {
        this.disabled = false;
        if (btnText) btnText.textContent = originalText;
        if (btnSpinner) btnSpinner.classList.add('hidden');
      }
    });
  });
});
</script>
{% endblock %}

